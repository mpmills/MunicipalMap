<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="translucent-black" />

    <title>New Jersey Meadowlands Commission &raquo; Municipal Map v.2</title>

    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/esri/css/esri.css" />

    <link rel="stylesheet" type="text/css" href="map.css" />

    <script>dojoConfig = { parseOnLoad:true };</script>
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.3"></script>
    <script src="MERI_Map_Properties.js"></script>
    <script src="MERI_formatting.js"></script>
    <script src="sorttable.js"></script>

</head>

<body class="claro">

<div id="wrapper">
<div id="framecontent">
<div class="innertube">
<div id="toolbar">
    <div id="navToolbar">
        <div class="tool_button" id="nav_zoom_in" 		title="Zoom In"					iconClass="zoominIcon" 		></div>
        <div class="tool_button" id="nav_zoom_out" 		title="Zoom Out"				iconClass="zoomoutIcon" 	></div>
        <div class="tool_button" id="nav_zoom_fullext" 	title="Zoom Full Extent"		iconClass="zoomfullextIcon" ></div>
        <div class="tool_button" id="nav_zoom_prev" 	title="Zoom Previous Extent" 	iconClass="zoomprevIcon"	></div>
        <div class="tool_button" id="nav_zoom_next" 	title="Zoom Next Extent"		iconClass="zoomnextIcon" 	></div>
        <div class="tool_button" id="nav_pan" 			title="Pan Map"					iconClass="panIcon" 		></div>
        <div class="tool_button" id="nav_identify" 		title="Identify"				 							></div>

        <div class="tool_button" id="nav_btn_select" 	title="Parcel Select"										></div>
        <div class="tool_button" id="nav_measure"		title="Measure"		 									    ></div>
        <div class="tool_button" id="nav_btn_erase"		title="Clear Map"											></div>

    </div>
</div>

<div id="tabs">
    <ul id="tablist">
        <li id="LayersToggle"><a href="#">Map Layers</a></li>
        <li id="SearchTab" class="summarize"><a href="#">Search</a></li>
        <li id="SelectionTab" class="summarize"><a href="#">Selections</a></li>
        <li id="HelpTab"><a href="#">About</a></li>
    </ul>
</div>

<div id="side_content">
<div id="left_content">

<div id="dMeasureWrap" class="ctrl_wipe">
    <div id="dMeasureTool" ></div>
</div>

<div id="SelectionPane" class="ctrl_wipe">

    <!--
    <div id="SelectionPaneTitle">pane_title</div>
    <div id="dResultsSummaryORIG">results_summary_orig</div>
    -->
    <div>
        <strong>Selections: </strong>
        <a href="#" onclick="selection_tab_display('selection_map');" class="selectionTab" id="selectionTabMap"> MAP &amp; SEARCH</a>
        <a href="#" onclick="selection_tab_display('selection_buffer');" class="selectionTab" id="selectionTabBuffer"> BUFFER </a>
    </div>

    <div id="selection_map" class="dSelectionResults">
        <div class="dSubtabTitle" title="Parcels selected from map clicks.">Selected Parcels ( Map &amp; Search)</div>
        <div id="dSelectionSummaryMap">No selections have been added from Map or Search.</div>
        <div id="r_map_selection"></div>
    </div>
    <div id="selection_buffer" class="dSelectionResults">
        <div class="dSubtabTitle" title="Parcels selected from Buffer Area">Parcels Selected from Buffer</div>
        <div id="dSelectionSummaryBuffer">No selections have been made from the buffer.</div>
        <div id="r_map_buffer"></div>
    </div>

    <!-- ERIS OUTPUT -->
    <div id="Links_ERIS"></div>
    <div id="Results_ERIS"></div>


    <!--<div id="dSearchResults" class="ctrl_wipe"></div>-->

</div><!-- SelectionPane-->
<!--<div id="treeToc"></div>-->

<div id="SearchPane">
    <div id="search_menu"><strong>Search: </strong>
        <a href="#" onclick="f_search_handler('search_PROP');">Property</a>
        <!-- <a href="#" onclick="f_search_handler("search_FAC");">Facility</a> -->
        <a href="#" onclick="f_search_handler('search_OWNR');">Owner</a>
    </div>

    <div id="search_PROP" style="display:block">
        <div class="dSubtabTitle">Search Properties</div>
        <!-- A D D R E S S -->
        <div class="searchParcelSection">

            <div title="Search by Property Address" class="search_field" name="Address">
                <label for="txtQueryAddress">Address:</label><input type="text" id="txtQueryAddress"  />
            </div>
        </div>
        <!-- B L O C K   L O T  -->
        <div class="searchParcelSection">
            <div>
                <label for="txtQueryBlock">Block:</label><input title="Search parcel Block" type="text" style="width:80px"  id="txtQueryBlock" value="" name="Block" />
                <label for="txtQueryLot">Lot:</label><input title="Search parcel Lot" type="text" style="width:80px" id="txtQueryLot"  value="" name="Lot" />
            </div>

        </div>

        <!-- A C R E A G E  -->
        <div class="searchAdvancedDiv">
            <div><b>Acreage</b>
                <label for="txtAcreageMin">Min:</label><input type="text" id="txtAcreageMin" style="width:40px;" title="Min Acreage" value="0"  class="search_field" name="AcrMin" /> &nbsp;&nbsp;
                <label for="txtAcreageMax">Max:</label><input type="text" id="txtAcreageMax" style="width:40px;" title="Max Acreage" value="1000" class="search_field" name="AcrMax" />
            </div>
        </div>

        <!-- S E A R C H   F I L T E R S -->
        <div class="dSearchFilterContainer">

            <div id="dSearchFilterToggle" class="dSearchFilterToggle" title="Click to expand search filters." style="cursor:pointer;">Search Options &amp; Filters (+)</div>

            <div id="dSearchFilters" class="filterOff" style="display:none">

                <div class="dSearchFilterItemsToggle">
                    <div title="">
                        <input type="checkbox" name="OldBL" value="true" id="b_searchOldBlockLot" checked="checked" />
                        <label for="b_searchOldBlockLot">Search historical blocks and lots?</label>
                    </div>
                    <div title="Uncheck this box if you would like to do a *wildcard* search. See Help for more details.">
                        <input type="checkbox" name="BlockLotExact" value="true" id="b_searchBlockLotExact" checked="checked" />
                        <label for="b_searchBlockLotExact">Find only exact matches?</label>
                    </div>
                </div>

                <!-- M U N I C I P A L I T Y   F I L T E R -->
                <div class="searchAdvancedDiv">

                    <div class="dSearchFilterItemsToggle">
                        <input type="radio" name="rdo_muni_search" id="rdo_muni_searchAll" checked="checked" />
                        <label for="rdo_muni_searchAll">All Municipalities</label>
                        <input type="radio" name="rdo_muni_search" id="rdo_muni_searchSelect" >
                        <label for="rdo_muni_searchSelect">Selected Municipalities</label>
                    </div>
                    <div id="search_munis" class="dSearchFilterItems" style="display:none"></div>

                </div>

                <!-- P A R C E L   D E S I G N A T I O N   F I L T E R -->
                <div class="searchAdvancedDiv">
                    <div class="dSearchFilterItemsToggle">
                        <input type="radio" name="rdo_qual_search" id="rdo_qual_searchAll" checked="checked" />
                        <label for="rdo_qual_searchAll">All Parcels</label>
                        <input type="radio" name="rdo_qual_search" id="rdo_qual_searchSelect">
                        <label for="rdo_qual_searchSelect">Designated Parcels</label>
                    </div>
                    <div id="search_qual" class="dSearchFilterItems" style="display:none" ></div>
                </div>

                <!-- L A N D   U S E   F I L T E R -->
                <div class="searchAdvancedDiv">

                    <div class="dSearchFilterItemsToggle">
                        <input type="radio" name="rdo_landuse_search" id="rdo_landuse_searchAll" checked="checked" />
                        <label for="rdo_landuse_searchAll">All Land Uses</label>
                        <input type="radio" name="rdo_landuse_search" id="rdo_landuse_searchSelect">
                        <label for="rdo_landuse_searchSelect">Selected Land Uses</label>
                    </div>
                    <div id="search_landuse" class="dSearchFilterItems" style="display:none"></div>

                </div>


            </div>

        </div>

        <input type="button" class="i_search_button" value="Search for Properties" id="i_btn_search_parcels"/>

        <!--<div id="r_search_parcel" class="search_results"></div>-->
        <div id="dSearchResultsSummary">0 Parcels / 0 Acres</div>
        <div id="dSearchResults_withSelected"><a href="#" onclick="f_search_addCheckedToSelection()">Add checked items to Selection.</a></div>

        <div id="dSearchResultsLoadingParcel">
            <div id="dLoadingSearch" style="display:none">
                <img src="http://webmaps.njmeadowlands.gov/images/loading_search.gif" id="imgSearchLoading" alt="Search is Loading...">
            </div>
        </div>

        <div id="dSearchResultsParcel">
            <table id="tblSearchResultsParcel" class="sortable">
                <thead>
                <tr>
                    <th class="sorttable_nosort"><input id="i_search_parcel_selectDeselect" type="checkbox" title="select/deselect all"></th>
                    <th>Address</th>
                    <th>Block</th>
                    <th>Lot</th>
                    <th>Tools</th>
                </tr>
                </thead>
                <tbody id="tblBodySearchResultsParcel">
                </tbody>
            </table>
        </div>

    </div>

    <div id="search_OWNR">
        <div class="dSubtabTitle">Search Property Owners</div>
        <label>Owner Name:</label>
        <input type="text" id="txtQueryOwner" title="Owner Search" value="" />
        <!--<input type="text" class="search_field"name="Owner" /><br /><br />-->
        <input type="button" class="i_search_button" id="i_btn_search_owners" value="Search Owners" />
        <div id="r_search_owner" class="search_results"></div>
        <div id="dSearchResultsLoadingOwner">
            <div id="dLoadingSearchOwners" style="display:none"><img src="http://webmaps.njmeadowlands.gov/images/loading_search.gif" id="imgSearchLoadingParcel" alt="Search is Loading..."></div>
        </div>

        <div id="dSearchResultsOwnerSummary"></div>
        <div id="dSearchResultsOwner"></div>
    </div><!-- search_OWNR -->


</div> <!-- Search -->

<div id="MapPane" class="ctrl_wipe" >
    <div id="map_images">
        <div class="toc_heading">Basemap Imagery</div>
    </div>
    <div id="map_layers">
        <div class="toc_heading">Map Layers</div>
        <div id="map_layer_groups"></div>
    </div>
</div>

<div id="HelpPane" style="display: block;">
    <h2 class="sectionTitle">About</h2>

    <div class="sidebarContainer">
        This version of NJMCís Municipal Map encompasses 8 years of data collected about its 14-constituent towns, including historical to present geographic information. Municipalities can gain access to these layers and records about properties that falls within their respective municipalities and identify pertinent information about each property in question. The layers include: parcels, land use, zoning, wetlands, riparian, encumbrance, FEMA and much more. In addition, MERI-GIS has been compiling utility data from stormwater manholes to sanitary lines so towns can visualize and further make decision on existing infrastructure and conditions. Imagery accessible on this application ranges from the 1930ís to 2010. New data will become available once they are complete. Visit MERIís webmaps periodically for timely updates.
    </div>
    <hr>


    <h2 class="sectionTitle">Disclaimer</h2>

    <div class="sidebarContainer">
        The information contained in this site is the best available according to the procedures and standards of the New Jersey Meadowlands Commission (NJMC)/Meadowlands Environmental Research Institute Geographic Information Systems group (MERI-GIS)<a id="disclaimerMoreLink" onclick="toggle_visibility('disclaimerMore'); toggle_visibility('disclaimerMoreLink');" target="_blank" title="read more" style="display:block;">...</a>

        <div id="disclaimerMore" style="display:none;">
            In order to maintain the quality and timeliness of the data, MERI-GIS regularly maintains the information in their databases and GIS layers. However, unintentional inaccuracies may occur. MERI-GIS has made every effort to present the information in a clear and understandable way for a variety of users. However, we cannot be responsible for the misuse or misinterpretation of the information presented by this system. Therefore, under no circumstances shall the NJMC/MERI-GIS be liable for any actions taken or omissions made from reliance on any information contained herein from whatever source nor shall the NJMC/MERI-GIS be liable for any other consequences from any such reliance.<br /><br />

            All data request shall be made directly to the GIS Department. Processing fees may apply and NJMCís data distribution agreement is required on all requests. The GIS Department can be contacted at <a href="mailto:merigis@njmeadowlands.gov">merigis@njmeadowlands.gov</a>.<br />

            <div style="text-align:right;"><a onclick="toggle_visibility('disclaimerMore'); toggle_visibility('disclaimerMoreLink');"><img src="http://webmaps.njmeadowlands.gov/imagery/images/icons_BK/more_arrow_up.png" title="collapse" /></a></div>


        </div>

    </div>
    <hr>
    <!-- -->
    <h2 class="sectionTitle" >Help</h2>

    <div class="sidebarContainer" >
        Need help using this application?<br /><br />

        A full guide covering everything from the basics all the way up to advanced features is provided <a href="help/" target="_blank">here</a>.
    </div>
    <hr >

    <!-- -->
    <h2 class="sectionTitle">ERIS</h2>

    <div class="sidebarContainer">
        <div id="signInForm">
            <form id="signInFormNode">

                <label class="eris_login_lbl">Username: </label><input type="text" name="userName" class="eris_login_fld" /><br />
                <label class="eris_login_lbl">Password: </label><input type="password" name="password" class="eris_login_fld" />

            </form>
            <button id="ERISLogin" onClick="ERISLogin();">Login</button>
        </div>

        <pre id="signInResultNode"></pre>

    </div>
    <hr>

    <!-- -->
    <h2 class="sectionTitle">METADATA</h2>

    <div class="sidebarContainer">
        Need the Metadata?<br /><br />

        A complete listing of all the GIS data is provided <a href="http://apps.njmeadowlands.gov/mapping/metadata/?c=municipal" target="_blank">here</a>.
    </div>
    <hr>

    <!-- -->
    <h2 class="sectionTitle">Contact</h2>

    <div class="sidebarContainer">
        We appreciate your feedback, please let us know what you think about the application using this <a href="http://apps.njmeadowlands.gov/feedback/?i=f&a=1" target="_blank">form.</a>
        <br />
        <br />

        You can also contact the MERI GIS Department at 201-460-4612
    </div>


</div>
</div><!-- left_content -->
</div><!-- side_content -->

<div id="footer"> &copy 2012 New Jersey Meadowlands Commission
    <div id="colapse"> <img src="images/icons_bk/left_arr16_2.png" onclick="coll_mnu();" alt="Collapse Menu" title="Collapse Menu" /></div>
</div>

</div><!-- innertube -->
</div><!-- framecontent -->
<div id="expand" >
    <div id="expand_bttn">
        <img src="images/arr_right.png" onclick="expnd_mnu();" alt="Expand Menu" title="Expand Menu" />
    </div>
</div>
<div id="map"></div>


</div><!-- wrapper -->

<div id="dSearchDivFloat"></div>

<div id="dBufferTool">
    <div id="dBufferToolTitle">Buffer Tool</div>
    <div>Buffer Distance (feet): <input type="text" id="bufferToolDistance" value="200"  /></div>
    <div><a id="aBufferParcelExec" href="#" title="Execute Buffer tool on selected parcels with the given distance." >Execute Buffer</a></div>
    <div id="dBufferToolSelectionSummary"></div>

    <div style="display:none">
        <div>Buffer Layer Visibilties</div>
        <div>
            <input id="chkBufferParcel" type="checkbox" checked="checked">Parcel to Buffer<br />
            <input type="checkbox" checked="checked">Parcel to Buffer<br />
        </div>
    </div>
</div>



<script type="text/javascript">

/*
 // Naming Conventions
 //
 //  MAP STUFF
 //
 //		M		-	Map
 //		IT		- 	Identify Task
 //		IP		- 	Identify Parameters
 //		TP		-	Task Parameters
 //		BP		-	Buffer Parameters
 //		Q		-	Query
 //		QT		-	Query Task
 //		EVT		-	Event
 // 	F		-	Feature
 // 	IW		-	Info Window
 // 	GS		-	GeoService
 // 	GeomS	-	Geometry Service
 //		S		-	Symbol
 //     G		-	Graphic
 //		LG		-	Layer Graphics
 //		LD		-	Layer Dynamic
 //		LT		-	Layer Tiled

 //
 //  OTHER STUFF
 //
 //		f_		-	javascript function
 //		e_		-	html element
 //		b_		-	boolean variable
 //		r_		-	search result divs
 //		GV_		-	global var
 //		_lbl	-	label
 */

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  D E P E N D E N C I E S
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

// dependecies object.. used on load to ensure all objects are loaded in advance
var dependencies = {
            "landuse":{"isLoaded":false},
            "legend":{"isLoaded":false}
        },
        loadingDialog;

// dojo requires
// esri loading
// parsing
require(
        [
            //"dgrid/OnDemandGrid",
            //"dgrid/Selection",
            //"dojo/store/Memory",
            //"esri/Map",
            //"esri/layers/FeatureLayer",
            //"dojo/_base/declare",
            //"dojo/number",
            //"dojo/parser",
            //"dojo/domReady!"
            //dijits

            "dijit/Dialog",
            "esri/dijit/Measurement",
            "dijit/layout/BorderContainer",
            "dijit/layout/TabContainer",
            "dijit/layout/ContentPane",

            "esri/dijit/Scalebar",
            "esri/dijit/OverviewMap",
            //"esri/dijit/Popup",

            //"dijit.Toolbar" // no longer need toolbar since we rolled our own

            // map components
            "esri/Map",
            "esri/toolbars/navigation",

            // tasks
            "esri/tasks/geometry",
            "esri/tasks/query",

            "dojo/domReady!"

        ],

        function( ){

            // set proxy options and path
            esri.config.defaults.io.alwaysUseProxy = false;
            esri.config.defaults.io.proxyUrl = DynamicLayerHost + "/proxy/proxy.ashx";

            // set the default geometry service
            esri.config.defaults.geometryService = new esri.tasks.GeometryService(DynamicLayerHost + "/ArcGIS/rest/services/Map_Utility/Geometry/GeometryServer");

            console.log("Dom Ready.....");

            loadingDialog = new dojo.dijit.Dialog({
                title: "N.J. Meadowlands Commission : Municipal Map",
                content: "<div style=\"text-align:center;margin-top:30px;margin-bottom:30px;\">"+
                        "<h2>Welcome to MERI's Municipal Map</h2>"+
                        "<div style=\"margin:20px 0 20px 0;\"><img src=\"images/meri_globe.gif\" ></div>"+ // map_loading_40.gif
                        "<h3 style=\"padding:0 40px 0 40px;\">Please be patient while the web application is prepared.</h3>"+
                        "</div>",

                style: "width:360px;position:relative;"
            });

            // request landuse and build object.
            dojo.xhrGet({
                // request the url for the LandUse Layer definition, including all domains
                url: "http://webmaps.njmeadowlands.gov/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/3?f=json",
                handleAs: "json",
                load: function(json) {
                    for( field in json.fields ){
                        if( json.fields[field].name == "LANDUSE_CODE"){
                            landuse_json = json.fields[field].domain.codedValues;
                        }
                    }
                    // now that data is loaded
                    dependencies["landuse"].isLoaded = true;
                    loadContinue( );
                },
                error: function() {
                    // in case of error fail to these values - 061312
                    landuse_json = [
                        {"code":"CO","name":"Commercial Office"},
                        {"code":"CR","name":"Commercial Retail"},
                        {"code":"HM","name":"Hotels and Motels"},
                        {"code":"IND","name":"Industrial"},
                        {"code":"ICC","name":"Industrial Commercial Complex"},
                        {"code":"PQP","name":"Public/Quasi Public Services"},
                        {"code":"RL","name":"Recreational Land"},
                        {"code":"RES","name":"Residential"},
                        {"code":"TRS","name":"Transportation"},
                        {"code":"WAT","name":"Water"},
                        {"code":"WET","name":"Wetlands"},
                        {"code":"000","name":"Unclassified"},
                        {"code":"CU","name":"Communication Utility"},
                        {"code":"MU","name":"Multiple Uses"},
                        {"code":"VAC","name":"Open Lands"},
                        {"code":"TL","name":"Transitional Lands"}
                    ];

                    dependencies["landuse"].isLoaded = true;
                    loadContinue( );
                }
            });

            // request legend from MunicipalMap_live service and set object.
            dojo.xhrGet({
                // The URL of the request
                url: DynamicLayerHost + "/ArcGIS/rest/services/Municipal/MunicipalMap_live/MapServer/legend?f=json",
                // The success callback with result from server
                handleAs:"json",
                handle: function( content ) {
                    //CLOGconsole.log( "map_legend", content);
                    map_legend = content;
                    dependencies["legend"].isLoaded = true;
                    loadContinue( );
                }
            });

            loadingDialog.show();

            // resize the left content pane on window resize
            dojo.connect( window, "onresize", resize_content_pane );

//
        }); // END onReady LOAD

// map globals;
var M_meri, basemap_dynamic, navToolbar, tool_selected,
        LD_base, LD_visible = [],
        LD_flooding, LD_flood_visible =[],
        ERIS_base,
        njmcExtent;

// ALL Local Variables converted to MapObject

// initialize variables
// query tasks
var QT_parcel, QT_owners, QT_address, QT_blockLot, QT_landuse, QT_landuse_parcel, QT_facility, QT_owner_int, QT_owner_parcels, QT_ERIS_selection, QT_ERIS_BIDtoINTERMEDIATE;

// queries
var Q_parcel, Q_owners, Q_address, Q_blockLot, Q_landuse, Q_landuse_parcel, Q_facility, Q_owner_int, Q_owner_parcels, Q_ERIS_selection, Q_ERIS_BIDtoINTERMEDIATE, Q_RTK_IDS;

// Identify Task, parameters, and layer array
var IT_Parcels, IP_Parcels, IT_Map_All, IP_Map_All, IP_Identify_Layers = [];

// selected graphic, map click event
var G_parcel_selected, EVT_parcel_click;

// object for collection of feature sets.. as returned by relationship query for owners -> int -> parcels
var featureSet_ownerParcels = [];

// object for collection of selected parcels and buffered parcels
var fSet_selected_parcels = [], fSet_buffered_parcels = [];

///////////////////////
// GRAPHIC LAYERS
///////////////////////

var GL_parcel_selection,// map click selections and search selections

// BUFFER
    GL_buffer_parcel, // selected parcels to buffer
    GL_buffer_buffer, // buffer area - actual buffer geometry calculated from buffer functionality
    GL_buffer_selected_parcels, // parcels selected from running the buffer

// SEARCH RESULTS
    GL_parcel_owners; // parcel owners


///////////////////////
// SYMBOLS
///////////////////////

var S_feature_selection, // selected parcels by map click
    S_feature_flash, // flash parcel symbol
    S_buffer_parcel, // parcels used for buffer
    S_buffer_buffer, // buffer area
    S_buffer_selected_parcels; // parcels selected from buffer

// BUFFER GEOMETRY SERVICE
var GS_parcel_selection_buffer;

// BUFFER TASK PARAMTERS
var TP_parcel_selection_buffer;

// NAVIGATION MENU SELECTION BASED QUERIES
var QT_parcel_selection, Q_parcel_selection;

// dojo dijits
var overviewMapDijit, measurementDijit, scalebarDijit;

// layer opacities
var L_opacities = {};

// IMAGE LAYER OBJECT. SET ON LOAD AND WHEN IMAGE LAYER IS TOGGLED
var IL_basemap;
// templates for features

// imagery layers.. toc imagery is dynamically built from JSON object
var map_legend, map_legend_eris;

// map layers... toc map layers is dynamically built from JSON object
var landuse_json;

// Tab Menus for Search and Selections
var SearchDivs = ["search_PROP","search_OWNR"];
var SelectionDivs = ["selection_map", "selection_buffer"];

var search_LandUseIDs = [];
var GV_current_ownerid;
var GV_searchtool_current;

//var DynamicLayerHost = "http://"+ location.hostname;
var DynamicLayerHost = "http://webmaps.njmeadowlands.gov";

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  D Y N A M I C   L A Y E R   L I S T
//
//	** Current the dynamic layerlist is drawn from the JSON object.
//  this could be adjusted below in the commented function that uses each
//  layers information to determine visibilities, etc.
//
//  ** ultimately we would like to have the layer list only list layers
//  that are visible at the current extent. might be too much for a simple layer.
//  maybe we can just disable the checkbox when the layer is not visible.
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function f_layer_list_build(  ) {

    //CLOGconsole.log("mapLayersJSON", mapLayersJSON);

    dojo.forEach( mapLayersJSON , function( group, index ){

        // create toc group div
        var e_div_group = dojo.doc.createElement("div");
        e_div_group.setAttribute("class","toc_group_div");
        e_div_group.id = "toc_grp_"+ group.id;

        // create toc group div title div
        var e_div_title = dojo.doc.createElement("div");
        e_div_title.setAttribute("class","toc_group_title");
        e_div_title.innerHTML = group.name;

        // create toc group layer div container div
        var e_div_group_layers = dojo.doc.createElement("div");
        e_div_group_layers.setAttribute("class","toc_group_container");
        e_div_group_layers.setAttribute("title", group.name);

        // add the title div to the group div
        e_div_group.appendChild( e_div_title);

        // loop through all group layers
        dojo.forEach( group.layers, function( layer, lyrIndex ){

            //create a new div element to hold the layer checkbox and name
            var e_div = dojo.doc.createElement("div");
            e_div.setAttribute("class","toc_layer_div");

            // create a new input checkbox element and assign its class, default visibility (check), click event and id
            var e_chk = dojo.doc.createElement("input");
            e_chk.type = "checkbox";
            e_chk.setAttribute("class","toc_layer_check");

            // test to see if layer checkbox should be checked by default; if so, check it
            if( layer.vis ) e_chk.setAttribute("checked", "checked");

            // test is the layer should be included in IDENTIFY results, if so add to array
            if( layer.ident ) IP_Identify_Layers.push(layer.id);

            e_chk.id = "m_layer_" + layer.id;
            e_chk.setAttribute("onclick", "f_layer_list_update()");

            // create a label element for the checkbox, set the for and innerHTML properties
            var e_lbl = dojo.doc.createElement("label");
            e_lbl.setAttribute("for", "m_layer_" + layer.id);
            e_lbl.setAttribute("class", "toc_layer_label");
            e_lbl.setAttribute("title", layer.desc);
            e_lbl.innerHTML = layer.name;

            // append legend anchor
            var e_legend_link = dojo.doc.createElement("span");
            e_legend_link.setAttribute("class","toc_legend_toggle toc_imagedown");
            e_legend_link.innerHTML = "<img id=\"toc_img_"+layer.id +"\" src=\"" + DynamicLayerHost + "/municipal/images/icons_BK/more_arrow_down.png\" />";
            e_legend_link.setAttribute("onclick", "toggle_visibility(\"toc_legend_" + layer.id + "\")");

            // append legend div
            var e_div_legend = dojo.doc.createElement("div");
            e_div_legend.setAttribute("class","toc_legend");
            e_div_legend.id = "toc_legend_"+ layer.id;

            e_div_legend.innerHTML = ""; //map_legend.layers[layer.id].layerName + "--- <br />";

            dojo.forEach( map_legend.layers[ layer.id ].legend, function( layer_legend ){
                e_div_legend.innerHTML += "<div> <img src=\"" + DynamicLayerHost + "/ArcGIS/rest/services/Municipal/MunicipalMap_live/MapServer/1/images/" + layer_legend.url + "\" />"+ layer_legend.label + " </div>";
            });

            // add checkbox and label to the div element
            e_div.appendChild( e_chk);
            e_div.appendChild( e_lbl);
            e_div.appendChild( e_legend_link);
            e_div.appendChild( e_div_legend);

            e_div_group_layers.appendChild( e_div);

        });

        // add current layers to group div
        e_div_group.appendChild( e_div_group_layers );

        // append group div to page div
        dojo.byId("map_layer_groups").appendChild( e_div_group);
    });

    // create toc group div for flooding
    var e_div_flood = dojo.doc.createElement("div");
    e_div_flood.setAttribute("class","toc_group_div");
    e_div_flood.id = "toc_grp_flood";

    // create toc group div title div
    var e_div_title = dojo.doc.createElement("div");
    e_div_title.setAttribute( "class", "toc_group_title" );
    e_div_title.innerHTML = map_layers_flooding_json.title;

    var e_flood_legend = dojo.doc.createElement("div");
    var img_flood_surge = dojo.doc.createElement("img");

    dojo.attr( img_flood_surge, {
        src: "http://webmaps.njmeadowlands.gov/ArcGIS/rest/services/Flooding/Flooding_Scenarios/MapServer/2/images/C5A8CAC6",
        alt: "Flooding due to tidal surge",
        "title": "Flooding due to tidal surge"
    });

    var img_flood_surge_lbl = dojo.doc.createElement("div");

    img_flood_surge_lbl.appendChild( img_flood_surge);
    img_flood_surge_lbl.appendChild( dojo.doc.createTextNode("Flooding due to tidal surge"));

    var img_flood_tgf = dojo.doc.createElement("img");

    dojo.attr(img_flood_tgf, {
        "src": "http://webmaps.njmeadowlands.gov/ArcGIS/rest/services/Flooding/Flooding_Scenarios/MapServer/3/images/5ABA6602",
        "alt": "TGF",
        "title": "Predicted Flooding in absence of tidegates"
    });

    var img_flood_tgf_lbl = dojo.doc.createElement("div");

    img_flood_tgf_lbl.appendChild( img_flood_tgf );
    img_flood_tgf_lbl.appendChild( dojo.doc.createTextNode("Predicted Flooding in absence of tidegates"));

    e_flood_legend.appendChild( img_flood_surge_lbl );
    e_flood_legend.appendChild( img_flood_tgf_lbl );

    e_div_flood.appendChild( e_div_title );
    e_div_flood.appendChild( e_flood_legend );

    // loop through all flooding scenarios and create a checkbox and link
    dojo.forEach( map_layers_flooding_json.scenarios, function( scenario, index ){

        // create div witch check box for scenario group
        var e_div_group = dojo.doc.createElement("div");
        e_div_group.setAttribute("class","toc_group_div flood_group");
        e_div_group.id = "toc_fld_"+ scenario.group;

        // add checkbox for scenario group
        var e_chk_group = dojo.doc.createElement("input");
        e_chk_group.type = "checkbox";
        e_chk_group.setAttribute("class","toc_layer_flood_check");

        if ( scenario.vis ) e_chk_group.setAttribute("checked", "checked");

        e_chk_group.id = "m_layer_flood_" + scenario.lyr;
        e_chk_group.setAttribute("onclick", "f_layer_list_flood_update()");

        var e_lbl_group = dojo.doc.createElement("label");
        e_lbl_group.setAttribute("for", "m_layer_flood_" + scenario.lyr);
        e_lbl_group.setAttribute("class", "toc_layer_label ");
        e_lbl_group.setAttribute("title", scenario.group + " Predicted Flooding in absence of tidegates");
        e_lbl_group.innerHTML = scenario.group + " Foot Tidal Surge";

        // append group checkbox and label
        e_div_group.appendChild( e_chk_group);
        e_div_group.appendChild( e_lbl_group);

        e_div_flood.appendChild( e_div_group);

    });

    // append all flood scenarios to flood toc container
    dojo.byId("map_layer_groups").appendChild( e_div_flood);


} // end layer_list_build function

function f_layer_list_update() {

    // create array of all checkboxes
    var inputs = dojo.query(".toc_layer_check"), input;

    // reset visibilties array
    LD_visible = [];

    // loop through all checkboxes; if checked, append to to visibilities array
    dojo.forEach( inputs, function( input ){
        if ( input.checked ) LD_visible.push( input.id.replace( "m_layer_", "" ) );
    });

    //if there aren"t any layers visible set the array to be -1
    if( LD_visible.length === 0) LD_visible.push(-1);

    // update the map layer visibilities
    LD_base.setVisibleLayers( LD_visible );
}

function f_layer_list_flood_update() {

    // create array of all checkboxes
    var inputs = dojo.query(".toc_layer_flood_check"), input;

    // reset visibilties array
    LD_flood_visible = [];

    // loop through all checkboxes; if checked, append to to visibilities array
    dojo.forEach(inputs,function(input){
        if ( input.checked ) LD_flood_visible.push( input.id.replace( "m_layer_flood_", "") );
    });

    //if there aren"t any layers visible set the array to be -1
    if ( LD_flood_visible.length === 0 ) LD_flood_visible.push( -1 );

    // update the map layer visibilities
    LD_flooding.setVisibleLayers( LD_flood_visible );
}

function f_layer_list_eris_update() {

    // create array of all checkboxes
    var inputs = dojo.query(".toc_layer_eris_check"), input;

    // reset visibilties array
    LD_eris_visible = [];

    // loop through all checkboxes; if checked, append to to visibilities array
    dojo.forEach( inputs, function( input ){
        if ( input.checked ) LD_eris_visible.push( input.id.replace( "m_layer_", "" ));
    });

    //if there aren"t any layers visible set the array to be -1
    if( LD_eris_visible.length === 0 ) LD_eris_visible.push( -1 );

    // update the map layer visibilities
    ERIS_base.setVisibleLayers( LD_eris_visible );
}

// expand and colapse all map layer groups

function f_toc_vis( show ){

    // get selection of all groups by class
    var groups = dojo.query( ".toc_group_container" );

    if( show ){
        dojo.forEach( groups , function( group ){
            dojo.style( group ,"display", "block");
        });
    }
    else{
        dojo.forEach( groups, function( group ){
            dojo.style( group, "display", "none" );
        });
    }
}

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  I M A G E R Y   L A Y E R S
//
//  ** this funtionality will allow the user to choose the desired
//  imagery base map
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function f_imagery_list_build( ){
    //CLOGconsole.log("Imagery Layers JSON:", imageryLayersJSON);

    dojo.forEach( imageryLayersJSON, function( img_lyr, index ){

        var e_div = dojo.doc.createElement("div");
        e_div.setAttribute("class","image_layer_div");
        e_div.setAttribute("title",img_lyr.desc);

        // create a new input radio element and assig its class,name,id and onclick event
        var e_rdo = dojo.doc.createElement("input");
        e_rdo.type = "radio";
        e_rdo.setAttribute( "class", "img_layer_rdo" );
        e_rdo.setAttribute( "name", "img_rdos" );
        e_rdo.id = img_lyr.id;

        e_rdo.setAttribute("onclick", "f_image_layer_toggle(\""+ img_lyr.id +"\")");

        // create a label element for the checkbox, set the for and innerHTML properties
        var e_lbl = dojo.doc.createElement("label");
        e_lbl.setAttribute("for", img_lyr.id);
        e_lbl.setAttribute("class", "img_layer_label");
        e_lbl.innerHTML = img_lyr.title;

        // add radio and label to the div element
        e_div.appendChild( e_rdo);
        e_div.appendChild( e_lbl);

        // append the div element to the map_layer placeholder
        dojo.byId("map_images").appendChild( e_div );
    });
}

function f_image_layer_toggle(img_layer){

    M_meri.removeLayer(IL_basemap);

    IL_basemap = new esri.layers.ArcGISImageServiceLayer( DynamicLayerHost + "/ArcGIS/rest/services/Imagery/" + img_layer + "/ImageServer");

    M_meri.addLayer( IL_basemap, 0 );
}

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  M A P    F U N C T I O N S  -  C L I C K   H A N D L E R
//
//  ** Click handler will determine which event is triggered when the
//  map is clicked.
//
//  the function that will be triggered is based on the currently
//  selected navigation item..
//
//  Global Var tool_selected
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function f_map_click_handler( evt_click ){

    // debug logging
    console.log("f_map_click_handler( evt_click)");
    console.log(evt_click);

    switch( tool_selected ){
        case "select": 		f_parcel_selection_exec( evt_click ); break;
        case "buffer": 		f_parcel_buffer_exec( evt_click ); break;
        case "identify": 	f_map_identify_exec( evt_click ); break;
        case "measure":		break; // set measure property, but functionality is controled by measure dijit
        case "pan": 		console.log("map mode is pan"); break;
    }
};

function f_toolbar_select(tool){

    // when user clicks tool in toolbar, set button style.. red border for now.. consider changing class for easier customization
    tools = ["nav_measure", "nav_btn_select", "nav_zoom_in", "nav_zoom_out", "nav_pan", "nav_identify"];

    dojo.forEach(tools, function(tool){
        dojo.style(tool,"border","none");
    });

    dojo.style(tool,"border","1px solid red");

};

function f_toolbar_reset(){

    // disable measurement and hide wrapping div
    measurementDijit.setTool("location",false);

    dojo.style( "dMeasureWrap", "display", "none");
    dojo.style( "dBufferTool", "display", "none")

};

// ESRI Idenfity function setup

function f_map_identify_init( ){

    IT_Map_All = new esri.tasks.IdentifyTask( DynamicLayerHost + "/ArcGIS/rest/services/Municipal/MunicipalMap_live/MapServer" );
    IP_Map_All = new esri.tasks.IdentifyParameters();
    IP_Map_All.tolerance = 3;
    IP_Map_All.returnGeometry = true;
    IP_Map_All.layerIds = IP_Identify_Layers; // use global settings, as determined by layer list build function and defined in map layer json obj
    IP_Map_All.layerOption = esri.tasks.IdentifyParameters.LAYER_OPTION_ALL;
    IP_Map_All.width  = M_meri.width;
    IP_Map_All.height = M_meri.height;
}

// ESRI Idenfity function execution
function f_map_identify_exec( click_evt ) {

    console.log("f_map_identify_exec", "click_evt", click_evt);

    IP_Map_All.geometry = click_evt.mapPoint;
    IP_Map_All.mapExtent = M_meri.extent;

    IT_Map_All.execute(IP_Map_All,function(identifyResults){

        dojo.forEach(identifyResults, function(identifyResult){

            // identifyResult has following objects
            // displayFieldName
            // feature
            // layerId
            // layerName

            // create layer div
            var el_layer = dojo.doc.createElement("div");
            //el_layer.id = "identLayer_" + identifyResult.layerName;
            el_layer.setAttribute("class","ident_layer");

            var el_layer_title = dojo.doc.createElement("div");
            el_layer_title.setAttribute("class","ident_layer_title");
            el_layer_title.innerHTML = toProperCase( identifyResult.layerName );

            // add the title div to the layer div
            el_layer.appendChild( el_layer_title);

            // loop through all attributes for this div
            dojo.forEach( identify_fields_json[ identifyResult.layerId ], function( attr ){

                //create attribute div
                var el_layer_attr = dojo.doc.createElement( "div" );
                el_layer_attr.setAttribute( "class", "ident_layer_attr" );

                var el_layer_attr_field = dojo.doc.createElement("span");
                el_layer_attr_field.setAttribute( "class", "ident_field" + " field_" + attr);
                el_layer_attr_field.innerHTML = fieldAlias(attr);

                var el_layer_attr_val = dojo.doc.createElement( "span" );
                el_layer_attr_val.setAttribute("class","ident_value" + " val_" + attr);
                el_layer_attr_val.innerHTML = identifyResult.feature.attributes[attr];

                // append field name span to attribute (row) div
                el_layer_attr.appendChild( el_layer_attr_field);

                // append field value span to attribute (row) div
                el_layer_attr.appendChild( el_layer_attr_val );
                el_layer.appendChild( el_layer_attr );
            });

            dojo.byId( "dIdentifyResults" ).appendChild( el_layer );
        });
    }, showerror);

}

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  P A R C E L ( S )    S E L E C T I O N
//
//  1. Select one or more parcels,
//
//  2. Save parcel featureSet to global object fSet_selected_parcels
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function f_parcel_selection_init(){

    // query on the Parcel Feature Class - layer id 0
    QT_parcel_selection = new esri.tasks.QueryTask( DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/0" );

    Q_parcel_selection = new esri.tasks.Query();
    Q_parcel_selection.returnGeometry = true;
    Q_parcel_selection.outFields = F_outFields.parcel;//["OBJECTID","PID","PAMS_PIN","MUN_CODE","BLOCK","LOT","OLD_BLOCK","OLD_LOT","FACILITY_NAME","PROPERTY_ADDRESS"];
}

function f_parcel_selection_exec( map_event ){
    // get map clicked point
    Q_parcel_selection.geometry = map_event.mapPoint;
    // run the query task and pass results to the process_results_parcel function, passing "selection" as the type
    QT_parcel_selection.execute( Q_parcel_selection, function( results ){
        console.log("parcel selected from map click");
        f_process_results_parcel_click( results );
        //f_process_results_parcel( "selection_map", results );
    });
}

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  S E L E C T I O N / B U F F E R  / O W N E R  G R A P H I C S   A C T I O N S
//
//  - all graphical operations have been combined for all collections..
//	includes parcel  selection and buffer selection
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *


function f_feature_action(funct, type, object_attr, oid){

    console.log( "f_feature_action(funct, type, object_attr, oid)");
    //devlog alert( "f_feature_action(funct, type, object_attr, oid)");
    console.log( funct, type, object_attr, oid);

    if(oid==="undefined"){alert("oid is undefined");}

    var graphics_layer, target_div, child_div;

    //devlog  alert("TYPE: " + type + " ( type switch needs to be refactored to combine funct and type?) ");

    switch( type ){

        case "search":
            graphics_layer = GL_query_parcel;
            target_div = "dSearchResultsParcel";
            //child_div = "searchParcel_" + oid;
            child_div = "r_parcel_" + oid;
            break;

        case "selection":
            graphics_layer = GL_parcel_selection;
            target_div = "r_map_selection";
            child_div = "selParcel_" + oid;
            break;

        case "parcel_owners":
            graphics_layer = GL_parcel_owners;
            target_div = "r_search_owners";
            child_div = "selParcelOwners_" +oid;
            break;

        case "buffer":
            graphics_layer = GL_buffer_selected_parcels; //<
            target_div = "r_map_buffer";
            child_div = "selParcelBuffer_" + oid;
            break;
        default:
            //devlog console.log("INVALID Featurea action TYPE");
            break;
    }

    console.log("graphics_layer, target_div, child_div, object_attr, summaryDiv");
    console.log(graphics_layer, target_div, child_div, object_attr);

    switch( funct ){

        case "Add to Selection":

            var selected_graphics = [];

            for(var i=0; i < GL_query_parcel.graphics.length; i++){

                if(GL_query_parcel.graphics[i].attributes.PID == oid){

                    f_search_add_selections([GL_query_parcel.graphics[i]]);

                    //devlog alert("graphic added for PID:" + oid);

                }
            };

            // updates search totals?
            //f_selectionUpdateSearchTotals( GL_parcel_selection, "dSelectionSummarySearch");
            // f_selectionUpdateSearchTotals( GL_parcel_selection, "dSelectionSummaryMap");

            // f_selectionUpdateSearch( GL_parcel_selection, "dSelectionSummaryMap");

            break;

        case "Zoom To":

            for( var x=0; x < graphics_layer.graphics.length; x++){
                var graphic = graphics_layer.graphics[x];
                if( graphic.attributes[ object_attr ] == oid ){
                    M_meri.setExtent(graphic.geometry.getExtent().expand(1.3),true );
                    break;
                }
            }
            break;

        case "Pan To":
            for(var x=0; x< graphics_layer.graphics.length;x++){
                var graphic = graphics_layer.graphics[x];
                if( graphic.attributes[object_attr] == oid ){
                    M_meri.centerAt(graphic.geometry.getExtent().getCenter());
                    break;
                }
            }
            break;

        case "Flash":
            for( var x=0; x < graphics_layer.graphics.length; x++){

                if( graphics_layer.graphics[ x ].attributes[ object_attr ] == oid ){

                    var divParcel = dojo.byId( child_div );
                    console.log("typeof", typeof divParcel, divParcel);

                    divParcel.scrollIntoView();

                    var divFlashColor = new dojo.Color( [ 98, 194, 204] )

                    // get current symbol so we can put it back correctly
                    var curSymbol = graphics_layer.graphics[x].symbol;

                    //todo: update flash symbol
                    var flashSymbol = new esri.symbol.SimpleFillSymbol(
                            esri.symbol.SimpleFillSymbol.STYLE_SOLID,
                            new esri.symbol.SimpleLineSymbol( esri.symbol.SimpleLineSymbol.STYLE_SOLID, divFlashColor, 2),
                            new dojo.Color( [ 98, 194, 204, 0.5 ] )
                    );

                    graphics_layer.graphics[x].setSymbol( flashSymbol );

                    divParcel.style.backgroundColor = divFlashColor;

                    setTimeout(
                            function( ){
                                graphics_layer.graphics[ x ].setSymbol( curSymbol );
                                divParcel.style.backgroundColor = "";

                                setTimeout(
                                        function( ){
                                            graphics_layer.graphics[ x ].setSymbol( flashSymbol );
                                            divParcel.style.backgroundColor = divFlashColor;

                                            setTimeout(
                                                    function( ){
                                                        graphics_layer.graphics[ x ].setSymbol( curSymbol );
                                                        divParcel.style.backgroundColor = "";

                                                    }, 750 )
                                        }, 750 )
                            }, 750 )
                    break;
                }
            }
            break;

        case "Remove":

            console.log("REMOVE from Graphics Layer", "OID = " + oid)
            for( var x = 0; x < graphics_layer.graphics.length; x++){

                if( graphics_layer.graphics[ x ].attributes[ object_attr ] == oid ){

                    // remove layer from map
                    graphics_layer.remove( graphics_layer.graphics[ x ] );

                    // remove layer from toc
                    dojo.byId( target_div ).removeChild( dojo.byId( child_div ) );
                    break;
                }
            }

            f_summarize_totals( graphics_layer.graphics, type, "dSelectionSummaryMap");

            break;
    }
};

function f_process_results_parcel_search( results ){

    // append search results to results table.. one table row per result

    //devlogalert("f_process_results_parcel_search( results )");
    console.log("f_process_results_parcel_search( results )");

    var target_div = "dSearchResultsSummary",  // which div should the summary results appear in
            feature_div = "searchProperty_", // each table row will be prepended with this key. used when access is needed to element
            GL_container = GL_query_parcel, // graphics layer to add results to
            GL_count = GL_container.graphics.length, // count of records currently in search results
            IW_template = F_IW_templates.parcel, // info window template.. defined in higher scope
            G_symbol = S_feature_selection, // graphic symbol for newly added search results
            object_attr = "PID", // object id field in result set.. used PID for parcel..
            el_tbody = dojo.byId("tblBodySearchResultsParcel"); // element reference to search results table to append to

    // iterate through all newly found search results
    for ( var i=0, il = results.features.length; i < il; i++) {

        // add a table row for each result.. show address, block, lot, and tools button
        var featureAttributes = results.features[ i ].attributes;

        // if feature does not already exist, add feature to search results
        if( !f_findAttributeInGL(GL_container, object_attr, featureAttributes.PID)){

            var graphic = results.features[ i ];

            console.log("GRAPHIC: ", GL_container, graphic, "typeof", featureAttributes.PID, GL_container.graphics[featureAttributes.PID]);

            graphic.setSymbol( G_symbol );
            graphic.infoTemplate = IW_template;

            GL_container.add( graphic );

            var GL_count = GL_container.graphics.length;

            // show all Parcel Attributes.. // show link to parcel layer // set header of template // set content of template

            /*
             BLOCK: "231"
             LOT: "5"
             MAP_ACRES: 8.04466118
             MUN_CODE: "0232"
             OLD_BLOCK: null
             OLD_LOT: null
             PAMS_PIN: "0232_231_5"
             PID: 39246
             PROPERTY_ADDRESS: "240 CHUBB AVE"
             QUALIFIER: "MD"
             TAX_ACRES: null
             */
            // create a table row for each search result

            var	el_tr = dojo.doc.createElement("tr");
            el_tr.setAttribute("id",feature_div + featureAttributes[ object_attr]);

            var el_checkbox = dojo.doc.createElement("input");
            el_checkbox.setAttribute("type","checkbox");
            el_checkbox.setAttribute("class","searchParcelCheckbox");
            el_checkbox.setAttribute("data-pid", featureAttributes[ object_attr ]);

            el_td0 = dojo.doc.createElement("td");
            el_td0.appendChild(el_checkbox);

            el_td1 = dojo.doc.createElement("td");
            //el_td1.innerHTML = FormatResult( "address", featureAttributes[ "address" ], "selection" );
            el_td1.innerHTML = featureAttributes[ "PROPERTY_ADDRESS" ];

            el_td2 = dojo.doc.createElement("td");
            //el_td2.innerHTML = FormatResult( "block", featureAttributes[ "block" ], "selection" );
            el_td2.innerHTML = featureAttributes[ "BLOCK" ];

            el_td3 = dojo.doc.createElement("td");
            //el_td3.innerHTML = FormatResult( "lot", featureAttributes[ "lot" ], "selection" );
            el_td3.innerHTML = featureAttributes[ "LOT" ];

            el_td4 = dojo.doc.createElement("td");
            //el_td4.innerHTML = "[tools]";

            var el_featureToolButton = dojo.doc.createElement("a");
            el_featureToolButton.setAttribute( "href", "#");
            el_featureToolButton.setAttribute("onclick","f_search_toolPopup('search',"+featureAttributes[ object_attr ] + ",this)");
            el_featureToolButton.innerHTML = "<img src=\"wrench.png\" style=\"height:22px;width:22px;\" >";
            // add imge here

            el_td4.appendChild(el_featureToolButton);

            el_tr.appendChild(el_td0);
            el_tr.appendChild(el_td1);
            el_tr.appendChild(el_td2);
            el_tr.appendChild(el_td3);
            el_tr.appendChild(el_td4);

            el_tbody.appendChild(el_tr);

        }
    }

    // update totals for search summary
    f_summarize_totals( GL_container.graphics, "search", target_div );
};

function f_search_addCheckedToSelection(){

    // select checked items from from search results and add to selection layer

    //devlogalert("with selected");
    var currentPIDSinLayer = f_getAttrAryFromGL( GL_parcel_selection, "PID"),
            graphicsAdded = 0;

    dojo.query(".searchParcelCheckbox:checked")
            .attr("data-pid")
            .forEach(
            function(pid){
                // test if pid already exists in GL_parcel_selection
                dojo.style("searchProperty_" + pid,{
                    "background-color":"white",
                    "text-decoration":"line-through"
                });

                if( ! InArray(currentPIDSinLayer,pid) ) {
                    f_feature_action("Add to Selection", "search", "PID", pid);
                    graphicsAdded++;
                }
            });

    //devlogalert(graphicsAdded + " graphic" + (graphicsAdded.length > 1 ? "":"s") +" added!");

};

function f_getAttrAryFromGL( GL, attr){

    var pids = [];

    GL.graphics.forEach(function(graphic){
        pids.push( graphic.attributes[attr] );
    });

    return pids;
};

function f_findAttributeInGL(GL, attr, attr_val){

    console.log("f_findAttributeInGL(GL, attr, attr_val)");
    console.log(GL, "attr:" + attr, "attr_val:" + attr_val);
    var returnVal = false;

    GL.graphics.forEach(function(graphic){
        if(graphic["attributes"][attr] == attr_val){
            returnVal = true;
        }
    });

    return returnVal;

//    // will need to loop through all graphics and search for graphics[each].attributes.PID
//    for ( var i=0; i < GL.graphics.length; i++){
//        if( GL.graphics[i].attributes[attr] == attr_val){
//            return true;
//            break;
//        }
//    }
//    return false;
}

function f_search_toolPopup(type, PID, evt){

    console.log(PID,event);
    // now create the tooltip div..

    /*

     evt properties.. can be removed

     altKey: false
     bubbles: true
     button: 0
     cancelBubble: false
     cancelable: true
     charCode: 0
     clientX: 260
     clientY: 358
     clipboardData: undefined
     ctrlKey: false
     currentTarget: null
     dataTransfer: null
     defaultPrevented: false
     detail: 1
     eventPhase: 0
     fromElement: null
     keyCode: 0
     layerX: 256
     layerY: 269
     metaKey: false
     offsetX: 25
     offsetY: 5
     pageX: 260
     pageY: 358
     relatedTarget: null
     returnValue: true
     screenX: 260
     screenY: 419
     shiftKey: false
     srcElement: HTMLAnchorElement
     target: HTMLAnchorElement
     timeStamp: 1352460003326
     toElement: HTMLAnchorElement
     type: "click"
     view: Window
     webkitMovementX: 0
     webkitMovementY: 0
     which: 1
     x: 260
     y: 358

     */

    var p = dojo.position(evt);

    var el_parcel_tools = dojo.doc.createElement("div");
    el_parcel_tools.id = "r_parcel_" + PID;
    el_parcel_tools.setAttribute("class","dParcelSearchToolPopup");

    // prepend content with a horizontal rule
    //el_parcel_tools.appendChild( dojo.doc.createElement("hr") );

    // create dom a element - tool to link to print map
    var el_featureToolPrint = dojo.doc.createElement("a");
    el_featureToolPrint.setAttribute( "href", printMapLink + PID );
    el_featureToolPrint.setAttribute( "target", "_blank" );
    el_featureToolPrint.innerHTML = "Print";

    //create feature action buttons for each result.. related function must be defined in
    dojo.forEach(["Add to Selection", "Zoom To", "Pan To", "Flash"], function(a){

        var el_featureTool = dojo.doc.createElement("a");
        el_featureTool.setAttribute("onclick", 'f_feature_action("'+ a +'","' + type + '","PID","' + PID +'")');
        el_featureTool.setAttribute("href","#");
        el_featureTool.innerHTML = a;

        el_parcel_tools.appendChild(el_featureTool);

    });

    // add close button
    var el_close = dojo.doc.createElement("a");
    el_close.setAttribute("href","#");
    el_close.innerHTML = "[X]";

    el_parcel_tools.appendChild( el_featureToolPrint );
    el_parcel_tools.appendChild( el_close );

    // clear the current popup and add the newly created one
    dojo.empty("dSearchDivFloat");
    dojo.byId("dSearchDivFloat").appendChild(el_parcel_tools);

    // select element at x y, then find top and left of that element

    dojo.style("dSearchDivFloat",{
        "left":(p.x - 5) + "px",
        "top": (p.y - 5) + "px",
        "visibility":"visible"
    });

    dojo.style(dojo.byId("searchProperty_"+PID), "border", "1px dashed red");

    // todo: add timer to close
    dojo.connect(el_parcel_tools, "mouseout", function(evt){
        //dojo.empty("dSearchDivFloat");
        //dojo.style(dojo.byId("dSearchDivFloat"), "visibility", "hidden");
    });

    // event listener for close button
    dojo.connect(el_close, "click", function(a){
        dojo.style(dojo.byId("dSearchDivFloat"), "visibility", "hidden");
        //dojo.empty("dSearchDivFloat");
    });

};

function f_search_add_selections(graphics){

    console.log("GRAPHICS from add selections " , graphics);

    // add a new graphic in the selections graphics layer for each parcel added
    // create a Parcel Item in list for each PID

    var target_div = "r_map_selection",
            summaryTarget = "dSelectionSummaryMap",
            feature_div = "selParcel_",
            GL_container = GL_parcel_selection,
            IW_template = F_IW_templates.parcel,
            G_symbol = S_feature_selection,
            object_attr = "PID";

    dojo.forEach(graphics, function(graphic){

        var featureAttributes = graphic.attributes;

        graphic.setSymbol( G_symbol );
        graphic.infoTemplate = IW_template;

        GL_container.add( graphic );

        var GL_count = GL_container.graphics.length;

        // show all Parcel Attributes.. // show link to parcel layer // set header of template // set content of template

        // create container element
        var el_parcel = dojo.doc.createElement("div");
        el_parcel.id = feature_div + featureAttributes[object_attr];
        el_parcel.setAttribute("class","dParcelItem");

        // prepend content with a horizontal rule
        el_parcel.appendChild( dojo.doc.createElement("hr") );

        // create dom a element - link to print map
        var el_featureToolPrint = dojo.doc.createElement("a");
        //el_featureToolFlash.setAttribute("onclick","f_feature_action("print",""+type+"",""+object_attr+"",""+ featureAttributes[object_attr] +"")");
        el_featureToolPrint.setAttribute( "href", printMapLink + featureAttributes[ object_attr ] );
        el_featureToolPrint.setAttribute( "target", "_blank" );
        el_featureToolPrint.innerHTML = "Print";

        // create dom a element - tool to view owners
        //var el_featureToolOwners = dojo.doc.createElement("a");
        //el_featureToolOwners.setAttribute("onclick","f_parcel_selection_owners(""+type+"",""+ featureAttributes["PID"] +"")");
        //el_featureToolOwners.setAttribute("href","#");
        //el_featureToolOwners.innerHTML = "View Owners";

        var el_featureAttribs = dojo.doc.createElement("div");
        el_featureAttribs.setAttribute( "class", "dSelParcelContainer" );

        // check if image is there
        //if so, create img

        // echo attributes.  can use a template here eventually.. just bold and show field contents for now
        var output = "<ul class=\"ResultList SelectionResult\">";
        for ( attr in featureAttributes ) {
            output +=  FormatResult( attr, featureAttributes[ attr ], "selection" );
        }
        output += "</ul>";

        el_featureAttribs.innerHTML += output;

        // create view more details link

        var el_viewMoreDiv = dojo.doc.createElement("div");
        el_viewMoreDiv.setAttribute("class","dSummaryViewMore")
        el_viewMoreDiv.id = "detail_"+feature_div +"_"+ featureAttributes[object_attr];

        var el_viewMoreToggle = dojo.doc.createElement("div");
        el_viewMoreToggle.setAttribute("class","dSummaryToggle");

        var el_viewMoreToggleLink = dojo.doc.createElement("a");
        el_viewMoreToggleLink.id="detail_view_a_"+featureAttributes[object_attr];
        el_viewMoreToggleLink.setAttribute("href","#");
        el_viewMoreToggleLink.innerHTML = "-- View More --";
        el_viewMoreToggleLink.setAttribute("onclick","f_result_detail(\"parcel\",\""+el_viewMoreDiv.id+"\"," + featureAttributes[object_attr] + "," + featureAttributes["oid"] +")");

        // add anchor to toggle div
        el_viewMoreToggle.appendChild( el_viewMoreToggleLink );

        // add toggle div to View More container
        el_viewMoreDiv.appendChild( el_viewMoreToggle );

        //create feature action buttons for each result
        dojo.forEach(["Remove", "Zoom To", "Pan To", "Flash"],function(a){

            var el_featureTool = dojo.doc.createElement("a");
            el_featureTool.setAttribute("onclick", "f_feature_action(\""+a+"\",\"" + "selection" + "\",\"" + object_attr + "\",\"" + featureAttributes[ object_attr ] +"\")");
            el_featureTool.setAttribute("href","#");
            el_featureTool.innerHTML = a;

            el_parcel.appendChild(el_featureTool);

        });

        el_parcel.appendChild( el_featureToolPrint );
        el_parcel.appendChild( el_featureAttribs );
        el_parcel.appendChild( el_viewMoreDiv );

        //el_parcel.appendChild( el_featureToolOwners);
        // no ownID is available, so we"ll need to create an additional owner search using parcel as entrance"
        //<a href="javascript:query_owner_int_exec("+feature.attributes["OWNID"]+")">view owner parcels</a>:<hr />

        //dojo.byId("r_search_" + GV_current_ownerid).appendChild( el_parcel);

        // if the type is a buffer, we will add the export to excel link

        dojo.byId( target_div ).appendChild( el_parcel );

    });


    f_summarize_totals( GL_container.graphics, "selection", summaryTarget );
};

function f_process_results_parcel_click( results ){

    //devlogalert("f_process_results_parcel_click( results )");

    var target_div = "r_map_selection",
            summaryTarget = "dSelectionSummaryMap",
            feature_div = "selParcel_",
            GL_container = GL_parcel_selection,
            IW_template = F_IW_templates.parcel,
            G_symbol = S_feature_selection,
            object_attr = "PID";

    GL_count = GL_container.graphics.length;

    for ( var i=0, il = results.features.length; i < il; i++) {

        var featureAttributes = results.features[ i ].attributes;
        var graphic = results.features[ i ];

        //if the layer type is buffer, append the PID list for the export link
        //if( type=="buffer" ){
        //	str_pid_list += featureAttributes[ "PID" ] + ",";
        //}

        graphic.setSymbol( G_symbol );
        graphic.infoTemplate = IW_template;

        GL_container.add( graphic );

        var GL_count = GL_container.graphics.length;

        // show all Parcel Attributes.. // show link to parcel layer // set header of template // set content of template

        // create container element
        var el_parcel = dojo.doc.createElement("div");
        el_parcel.id = feature_div + featureAttributes[object_attr];
        el_parcel.setAttribute("class","dParcelItem");

        // prepend content with a horizontal rule
        el_parcel.appendChild( dojo.doc.createElement("hr") );

        // create dom a element - link to print map
        var el_featureToolPrint = dojo.doc.createElement("a");
        //el_featureToolFlash.setAttribute("onclick","f_feature_action("print",""+type+"",""+object_attr+"",""+ featureAttributes[object_attr] +"")");
        el_featureToolPrint.setAttribute( "href", printMapLink + featureAttributes[ object_attr ] );
        el_featureToolPrint.setAttribute( "target", "_blank" );
        el_featureToolPrint.innerHTML = "Print";

        // create dom a element - tool to view owners
        //var el_featureToolOwners = dojo.doc.createElement("a");
        //el_featureToolOwners.setAttribute("onclick","f_parcel_selection_owners(""+type+"",""+ featureAttributes["PID"] +"")");
        //el_featureToolOwners.setAttribute("href","#");
        //el_featureToolOwners.innerHTML = "View Owners";

        var el_featureAttribs = dojo.doc.createElement("div");
        el_featureAttribs.setAttribute( "class", "dSelParcelContainer" );

        // check if image is there
        //if so, create img

        // echo attributes.  can use a template here eventually.. just bold and show field contents for now
        var output = "<ul class=\"ResultList SelectionResult\">";
        for ( attr in featureAttributes ) {
            output +=  FormatResult( attr, featureAttributes[ attr ], "selection" );
        }
        output += "</ul>";

        el_featureAttribs.innerHTML += output;

        // create view more details link

        var el_viewMoreDiv = dojo.doc.createElement("div");
        el_viewMoreDiv.setAttribute("class","dSummaryViewMore")
        el_viewMoreDiv.id = "detail_"+feature_div +"_"+ featureAttributes[object_attr];

        var el_viewMoreToggle = dojo.doc.createElement("div");
        el_viewMoreToggle.setAttribute("class","dSummaryToggle");

        var el_viewMoreToggleLink = dojo.doc.createElement("a");
        el_viewMoreToggleLink.id="detail_view_a_"+featureAttributes[object_attr];
        el_viewMoreToggleLink.setAttribute("href","#");
        el_viewMoreToggleLink.innerHTML = "-- View More --";
        el_viewMoreToggleLink.setAttribute("onclick","f_result_detail(\"parcel\",\""+el_viewMoreDiv.id+"\"," + featureAttributes[object_attr] + "," + featureAttributes["oid"] +")");

        // add anchor to toggle div
        el_viewMoreToggle.appendChild( el_viewMoreToggleLink );

        // add toggle div to View More container
        el_viewMoreDiv.appendChild( el_viewMoreToggle );

        //create feature action buttons for each result
        dojo.forEach(["Remove", "Zoom To", "Pan To", "Flash"],function(a){

            var el_featureTool = dojo.doc.createElement("a");
            el_featureTool.setAttribute("onclick", "f_feature_action(\""+a+"\",\"" + "selection" + "\",\"" + object_attr + "\",\"" + featureAttributes[ object_attr ] +"\")");
            el_featureTool.setAttribute("href","#");
            el_featureTool.innerHTML = a;

            el_parcel.appendChild(el_featureTool);

        });

        el_parcel.appendChild( el_featureToolPrint );
        el_parcel.appendChild( el_featureAttribs );
        el_parcel.appendChild( el_viewMoreDiv );

        //el_parcel.appendChild( el_featureToolOwners);
        // no ownID is available, so we"ll need to create an additional owner search using parcel as entrance"
        //<a href="javascript:query_owner_int_exec("+feature.attributes["OWNID"]+")">view owner parcels</a>:<hr />

        //dojo.byId("r_search_" + GV_current_ownerid).appendChild( el_parcel);

        // if the type is a buffer, we will add the export to excel link

        dojo.byId( target_div ).appendChild( el_parcel );
    }

    f_summarize_totals( GL_container.graphics, "selection", summaryTarget );


};

function f_process_results_buffer( results ){ // results from buffer is feature set

    var target_div = "r_map_buffer",
            feature_div = "selParcelBuffer_",
            GL_container = GL_buffer_selected_parcels,
            GL_count =  GL_container.graphics.length,
            IW_template,
            G_symbol,
            object_attr,
            IW_template = F_IW_templates.parcel,
            G_symbol = S_feature_selection,
            summaryTarget = "dSelectionSummaryBuffer",
            object_attr = "PID";

    for ( var i=0, il = results.features.length; i < il; i++) {

        var featureAttributes = results.features[ i ].attributes;
        var graphic = results.features[ i ];

        //if the layer type is buffer, append the PID list for the export link
        //if( type=="buffer" ){
        //	str_pid_list += featureAttributes[ "PID" ] + ",";
        //}

        graphic.setSymbol( G_symbol );
        graphic.infoTemplate = IW_template;

        GL_container.add( graphic );

        var GL_count = GL_container.graphics.length;

        // show all Parcel Attributes.. // show link to parcel layer // set header of template // set content of template

        // create container element
        var el_parcel = dojo.doc.createElement("div");
        el_parcel.id = feature_div + featureAttributes[object_attr];
        el_parcel.setAttribute("class","dParcelItem");

        // prepend content with a horizontal rule
        el_parcel.appendChild( dojo.doc.createElement("hr") );

        // create dom a element - link to print map
        var el_featureToolPrint = dojo.doc.createElement("a");
        //el_featureToolFlash.setAttribute("onclick","f_feature_action("print",""+type+"",""+object_attr+"",""+ featureAttributes[object_attr] +"")");
        el_featureToolPrint.setAttribute( "href", printMapLink + featureAttributes[ object_attr ] );
        el_featureToolPrint.setAttribute( "target", "_blank" );
        el_featureToolPrint.innerHTML = "Print";

        // create dom a element - tool to view owners
        //var el_featureToolOwners = dojo.doc.createElement("a");
        //el_featureToolOwners.setAttribute("onclick","f_parcel_selection_owners(""+type+"",""+ featureAttributes["PID"] +"")");
        //el_featureToolOwners.setAttribute("href","#");
        //el_featureToolOwners.innerHTML = "View Owners";

        var el_featureAttribs = dojo.doc.createElement("div");
        el_featureAttribs.setAttribute( "class", "dSelParcelContainer" );

        // check if image is there
        //if so, create img

        // echo attributes.  can use a template here eventually.. just bold and show field contents for now
        var output = "<ul class=\"ResultList SelectionResult\">";
        for ( attr in featureAttributes ) {
            output +=  FormatResult( attr, featureAttributes[ attr ], "selection" );
        }
        output += "</ul>";

        el_featureAttribs.innerHTML += output;

        // create view more details link

        var el_viewMoreDiv = dojo.doc.createElement("div");
        el_viewMoreDiv.setAttribute("class","dSummaryViewMore")
        el_viewMoreDiv.id = "detail_"+feature_div +"_"+ featureAttributes[object_attr];

        var el_viewMoreToggle = dojo.doc.createElement("div");
        el_viewMoreToggle.setAttribute("class","dSummaryToggle");

        var el_viewMoreToggleLink = dojo.doc.createElement("a");
        el_viewMoreToggleLink.id="detail_view_a_"+featureAttributes[object_attr];
        el_viewMoreToggleLink.setAttribute("href","#");
        el_viewMoreToggleLink.innerHTML = "-- View More --";
        el_viewMoreToggleLink.setAttribute("onclick","f_result_detail(\"parcel\",\""+el_viewMoreDiv.id+"\"," + featureAttributes[object_attr] + "," + featureAttributes["oid"] +")");

        // add anchor to toggle div
        el_viewMoreToggle.appendChild( el_viewMoreToggleLink );

        // add toggle div to View More container
        el_viewMoreDiv.appendChild( el_viewMoreToggle );

        //create feature action buttons for each result
        dojo.forEach(["Remove", "Zoom To", "Pan To", "Flash"],function(a){

            var el_featureTool = dojo.doc.createElement("a");
            el_featureTool.setAttribute("onclick", "f_feature_action(\""+a+"\",\"" + "buffer" + "\",\"" + object_attr + "\",\"" + featureAttributes[ object_attr ] +"\")");
            el_featureTool.setAttribute("href","#");
            el_featureTool.innerHTML = a;

            el_parcel.appendChild(el_featureTool);

        });

        el_parcel.appendChild( el_featureToolPrint );
        el_parcel.appendChild( el_featureAttribs );
        el_parcel.appendChild( el_viewMoreDiv );

        //el_parcel.appendChild( el_featureToolOwners);
        // no ownID is available, so we"ll need to create an additional owner search using parcel as entrance"
        //<a href="javascript:query_owner_int_exec("+feature.attributes["OWNID"]+")">view owner parcels</a>:<hr />

        //dojo.byId("r_search_" + GV_current_ownerid).appendChild( el_parcel);

        // if the type is a buffer, we will add the export to excel link

        dojo.byId( target_div ).appendChild( el_parcel );
    }

    f_summarize_totals( GL_container.graphics, "buffer", summaryTarget );

    f_summarize_totals( GL_container.graphics, "buffer", "dBufferToolSelectionSummary" );

};

function f_process_results_parcel( type, results ){

    //devlogalert("F PROCESS RESULTS PARCEL.. if this runs, updates are needed");

    console.log("f_process_results_parcel( type, results )");
    console.log(type, results );

    var target_div,
            feature_div,
            GL_container,
            GL_count,
            IW_template,
            G_symbol,
            object_attr,
            summaryTarget = "dSearchResultsSummary"; // default summaryTarget

    console.log(" Target: || " + target_div + "\n");

    // set field as PID, only changes are Facility and owner
    object_attr = "PID";

    // set appropriate graphics title, graphics layer, info window template, graphic symbol, and GL count
    switch(type){

        case "parcel":

            GL_container = GL_query_parcel;
            IW_template = F_IW_templates.parcel;
            G_symbol = S_feature_selection;
            target_div = "dSearchResultsParcel";
            feature_div = "r_parcel_";

            //devlogalert("process_results_parcel with summary type..." + type)

            break;

//        case "landuse":
//
//            target_div = "r_facility";
//            feature_div = "r_facility_";
//
//            GL_container = GL_query_landuse;
//            IW_template = F_IW_templates.parcel;
//            target_div = "r_facility";
//            feature_div = "r_facility_";
//            break;

//        case "facility":
//            target_div = "r_search_facility";
//
//            GL_container = GL_query_facility;
//            IW_template = F_IW_templates.parcel;
//            G_symbol = S_feature_selection;
//
//            feature_div = "selParcelFacility_";
//            object_attr = "BID"
//            break;

        case "parcel_owners":
            target_div = "r_owner";
            summaryTarget = "dSearchResultsOwnerSummary";

            feature_div = "selParcelOwner";

            //feature_div = "selParcelOwner_";

            GL_container = GL_parcel_owners;
            IW_template = F_IW_templates.parcel;
            G_symbol = S_feature_selection;
            break;

        case "search_selection":
        case "selection":

            target_div = "r_map_selection";
            summaryTarget = "dSelectionSummaryMap";

            feature_div = "selParcel_";

            GL_container = GL_parcel_selection;
            IW_template = F_IW_templates.parcel;
            G_symbol = S_feature_selection;

            break;

        case "buffer":
            target_div = "r_map_buffer";
            feature_div = "selParcelBuffer_";

            GL_container = GL_buffer_selected_parcels;
            IW_template = F_IW_templates.parcel;
            G_symbol = S_feature_selection;

            summaryTarget = "dSelectionSummaryBuffer";

            break;
    }

    // set graphics count so we have position to the array element
    GL_count = GL_container.graphics.length;

    console.log("Type: " + type + "\nTarget: " + target_div + "\n Feature Count: "+ GL_count);

    for ( var i=0, il = results.features.length; i < il; i++) {

        var featureAttributes = results.features[ i ].attributes;
        var graphic = results.features[ i ];

        //if the layer type is buffer, append the PID list for the export link
        //if( type=="buffer" ){
        //	str_pid_list += featureAttributes[ "PID" ] + ",";
        //}

        graphic.setSymbol( G_symbol );
        graphic.infoTemplate = IW_template;

        GL_container.add( graphic );

        var GL_count = GL_container.graphics.length;

        // show all Parcel Attributes.. // show link to parcel layer // set header of template // set content of template

        // create container element
        var el_parcel = dojo.doc.createElement("div");
        el_parcel.id = feature_div + featureAttributes[object_attr];
        el_parcel.setAttribute("class","dParcelItem");

        // prepend content with a horizontal rule
        el_parcel.appendChild( dojo.doc.createElement("hr") );

        // create dom a element - link to print map
        var el_featureToolPrint = dojo.doc.createElement("a");
        //el_featureToolFlash.setAttribute("onclick","f_feature_action("print",""+type+"",""+object_attr+"",""+ featureAttributes[object_attr] +"")");
        el_featureToolPrint.setAttribute( "href", printMapLink + featureAttributes[ object_attr ] );
        el_featureToolPrint.setAttribute( "target", "_blank" );
        el_featureToolPrint.innerHTML = "Print";

        // create dom a element - tool to view owners
        //var el_featureToolOwners = dojo.doc.createElement("a");
        //el_featureToolOwners.setAttribute("onclick","f_parcel_selection_owners(""+type+"",""+ featureAttributes["PID"] +"")");
        //el_featureToolOwners.setAttribute("href","#");
        //el_featureToolOwners.innerHTML = "View Owners";

        var el_featureAttribs = dojo.doc.createElement("div");
        el_featureAttribs.setAttribute( "class", "dSelParcelContainer" );

        // check if image is there
        //if so, create img

        // echo attributes.  can use a template here eventually.. just bold and show field contents for now
        var output = "<ul class=\"ResultList SelectionResult\">";
        for ( attr in featureAttributes ) {
            output +=  FormatResult( attr, featureAttributes[ attr ], "selection" );
        }
        output += "</ul>";

        el_featureAttribs.innerHTML += output;

        // create view more details link

        var el_viewMoreDiv = dojo.doc.createElement("div");
        el_viewMoreDiv.setAttribute("class","dSummaryViewMore")
        el_viewMoreDiv.id = "detail_"+feature_div +"_"+ featureAttributes[object_attr];

        var el_viewMoreToggle = dojo.doc.createElement("div");
        el_viewMoreToggle.setAttribute("class","dSummaryToggle");

        var el_viewMoreToggleLink = dojo.doc.createElement("a");
        el_viewMoreToggleLink.id="detail_view_a_"+featureAttributes[object_attr];
        el_viewMoreToggleLink.setAttribute("href","#");
        el_viewMoreToggleLink.innerHTML = "-- View More --";
        el_viewMoreToggleLink.setAttribute("onclick","f_result_detail(\"parcel\",\""+el_viewMoreDiv.id+"\"," + featureAttributes[object_attr] + "," + featureAttributes["oid"] +")");

        // add anchor to toggle div
        el_viewMoreToggle.appendChild( el_viewMoreToggleLink );

        // add toggle div to View More container
        el_viewMoreDiv.appendChild( el_viewMoreToggle );

        //create feature action buttons for each result
        dojo.forEach(["Remove", "Zoom To", "Pan To", "Flash"],function(a){

            var el_featureTool = dojo.doc.createElement("a");
            el_featureTool.setAttribute("onclick", "f_feature_action(\""+a+"\",\"" + type + "\",\"" + object_attr + "\",\"" + featureAttributes[ object_attr ] +"\")");
            el_featureTool.setAttribute("href","#");
            el_featureTool.innerHTML = a;

            el_parcel.appendChild(el_featureTool);

        });

        el_parcel.appendChild( el_featureToolPrint );
        el_parcel.appendChild( el_featureAttribs );
        el_parcel.appendChild( el_viewMoreDiv );

        //el_parcel.appendChild( el_featureToolOwners);
        // no ownID is available, so we"ll need to create an additional owner search using parcel as entrance"
        //<a href="javascript:query_owner_int_exec("+feature.attributes["OWNID"]+")">view owner parcels</a>:<hr />

        //dojo.byId("r_search_" + GV_current_ownerid).appendChild( el_parcel);

        // if the type is a buffer, we will add the export to excel link

        dojo.byId( target_div ).appendChild( el_parcel );
    }

    f_summarize_totals( GL_container.graphics, type, summaryTarget );


};


// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  B U F F E R   F U N C T I O N S
//
//  Functions:
//
//  A) Buffer Parcels "parcel_buffer_selection"
//
//     1) Select Parcels, return geometries
//     2) Buffer parcel geometry by user provided distance
//     3) Intersect Parcel Buffer with Parcels Layer, return featureSet
//     4) Show results in tab
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function f_parcel_buffer_init( ){

    // 1. initialize query functionality

    Q_parcel_selection_buffer = new esri.tasks.Query();
    QT_parcel_selection_buffer = new esri.tasks.QueryTask( DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/0" );
    Q_parcel_selection_buffer.returnGeometry = true;

    Q_parcel_selection_buffer.spatialRelationship = esri.tasks.Query.SPATIAL_REL_INTERSECTS;

    Q_parcel_selection_buffer.outFields = F_outFields.parcel;
    Q_parcel_selection_buffer.outSpatialReference = {"wkid":3424};

}

function f_multi_parcel_buffer_exec( ){

    // this function runs the buffer execute function for multiple parcels..
    // we will iterate through the selected parcels graphics layer, collecting the geometries.. the geometries will be passed to the parcel buffer Query Paramter geometry

    // hide any info windows
    M_meri.infoWindow.hide();

    // collect geometries from parcel selection graphics layer -> GL _parcel_selection

    // this polygon will hold all the individual polygon rings in as a multipart feature
    var multiparcel_geometries = esri.geometry.Polygon(new esri.SpatialReference({"wkid":3424}));

    // add individual polygon rings to multipart feature
    for(var m=0; m<GL_parcel_selection.graphics.length; m++){
        multiparcel_geometries.addRing(GL_parcel_selection.graphics[m].geometry.rings[0]);
    }

    var bufferDistanceTxt = dojo.byId("bufferToolDistance").value;
    var bufferDistance = 200;

    if( isNaN( bufferDistanceTxt ) || ( bufferDistanceTxt == "" ) ){
        alert("Buffer Tool Error:\n\nYou must enter a numeric distance for the buffer tool.");
    }
    else{
        // set up query and query task on parcels
        var QT_parcel_selection_buffer = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/0");
        var Q_parcel_selection_buffer = new esri.tasks.Query();

        bufferDistance = bufferDistanceTxt;

        // set up intersection query. use INTERSECTS spatial relationship
        Q_parcel_selection_buffer.returnGeometry = true;
        Q_parcel_selection_buffer.spatialRelationship = esri.tasks.Query.SPATIAL_REL_INTERSECTS;
        Q_parcel_selection_buffer.outFields = F_outFields.parcel;
        Q_parcel_selection_buffer.outSpatialReference = {"wkid":3424};

        // new geometry service
        var GeomS_parcel_buffer = new esri.tasks.GeometryService(DynamicLayerHost + "/ArcGIS/rest/services/Map_Utility/Geometry/GeometryServer");

        // set selected parcel
        //var G_parcel_selected = GL _parcel_selection.graphics;
        // set symbol and innfo window.. use templates
        //G_parcel_selected.setSymbol(S_buffer_parcel);
        //G_parcel_selected.setInfoTemplate(new esri.InfoTemplate(F_IW_templates.parcel));

        // set the buffer parameters.. default to 200 foot
        var BP_parcel_selection = new esri.tasks.BufferParameters();

        BP_parcel_selection.geometries  = [multiparcel_geometries];

        // add selected parcel graphic (clicked on parcel)
        //newnewGL_buffer_parcel = GL_parcel_selection;
        GL_buffer_parcel = GL_parcel_selection;

        BP_parcel_selection.distances = [ bufferDistance ];
        BP_parcel_selection.unit = esri.tasks.GeometryService.UNIT_FOOT;
        BP_parcel_selection.bufferSpatialReference = {"wkid": 3424};
        BP_parcel_selection.outSpatialReference = {"wkid": 3424};

        console.log("ready to run buffer");
        // run the geometry service buffer with buffer parameters, returns geometries o
        GeomS_parcel_buffer.buffer(BP_parcel_selection,function(geometries) {

            // add buffer ring graphic

            var graphic = new esri.Graphic(geometries[0],S_buffer_buffer);
            GL_buffer_buffer.add(graphic);

            Q_parcel_selection_buffer.geometry = graphic.geometry;
            Q_parcel_selection_buffer.outSpatialReference = {"wkid":3424};

            // eqecute the buffer query task. pass results to unified results function for processing
            QT_parcel_selection_buffer.execute(Q_parcel_selection_buffer, function (fset){

                        f_process_results_buffer(fset);


                        console.log("\nsingle parcel buffer selection complete");
                    }
                    , showerror);
            console.log("\nexecuting query with parcel buffer graphic");
        },showerror);

        console.log("\ndo parcel-buffered parcel intersection query..listen for callback");
    }
}

function f_parcel_buffer_exec( click_evt ){

    console.log("f_parcel_buffer_exec", "click_evt", click_evt);
    // this function runs the buffer execute function.. it is initiated by the map click event handler

    // hide any info windows
    M_meri.infoWindow.hide();

    //set parcel click event and set buffer geometry to map point. point is used to select the parcel
    EVT_parcel_click = Q_parcel_selection_buffer.geometry = click_evt.mapPoint;

    fSet_buffered_parcels = [];

    // execute buffer with query. send results to f_parcel_buffer_results function
    QT_parcel_selection_buffer.execute( Q_parcel_selection_buffer, f_parcel_buffer_results, showerror );

}

function f_parcel_buffer_results( graphics ){

    console.log("f_parcel_buffer_results", "graphics", graphics)

    var bufferDistanceTxt = dojo.byId("bufferToolDistance").value;
    var bufferDistance = 200;

    if( isNaN( bufferDistanceTxt ) || ( bufferDistanceTxt == "" )){
        alert("Buffer Tool Error:\n\nYou must enter a numeric distance for the buffer tool.");
    }
    else{
        // set up query and query task on parcels
        var QT_parcel_selection_buffer = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/0");
        var Q_parcel_selection_buffer = new esri.tasks.Query();

        bufferDistance = bufferDistanceTxt;

        // set up intersection query. use INTERSECTS spatial relationship
        Q_parcel_selection_buffer.returnGeometry = true;
        Q_parcel_selection_buffer.spatialRelationship = esri.tasks.Query.SPATIAL_REL_INTERSECTS;
        Q_parcel_selection_buffer.outFields = F_outFields.parcel;
        Q_parcel_selection_buffer.outSpatialReference = {"wkid":3424};

        // new geometry service
        var GeomS_parcel_buffer = new esri.tasks.GeometryService(DynamicLayerHost + "/ArcGIS/rest/services/Map_Utility/Geometry/GeometryServer");

        // set selected parcel
        var G_parcel_selected = graphics.features[0];

        // set symbol and info window.. use templates
        G_parcel_selected.setSymbol(S_buffer_parcel);

        G_parcel_selected.setInfoTemplate( new esri.InfoTemplate( F_IW_templates.parcel ) );

        // set the buffer parameters.. default to 200 foot
        var BP_parcel_selection = new esri.tasks.BufferParameters();
        BP_parcel_selection.geometries  = [G_parcel_selected.geometry];

        // add selected parcel graphic (clicked on parcel)
        GL_buffer_parcel.add(G_parcel_selected);

        BP_parcel_selection.distances = [ bufferDistance ];
        BP_parcel_selection.unit = esri.tasks.GeometryService.UNIT_FOOT;
        BP_parcel_selection.bufferSpatialReference = {"wkid": 3424};
        BP_parcel_selection.outSpatialReference = {"wkid": 3424};

        // run the geometry service buffer with buffer parameters, returns geometries o
        GeomS_parcel_buffer.buffer(BP_parcel_selection,function(geometries) {

            // add graphic to the map
            var graphic = new esri.Graphic(geometries[0],S_buffer_selected_parcels);

            // add buffer ring graphic
            GL_buffer_buffer.add(graphic)

            // set selected parcel geometry as the geometry for secondary query
            Q_parcel_selection_buffer.geometry = graphic.geometry;
            Q_parcel_selection_buffer.outSpatialReference = {"wkid":3424};

            // eqecute the buffer query task. pass results to unified results function for processing
            QT_parcel_selection_buffer.execute(Q_parcel_selection_buffer, function (fset){


                        f_process_results_parcel( "buffer", fset);

                        console.log("\nsingle parcel buffer selection complete");
                    }
                    , showerror);
            console.log("\nexecuting query with parcel buffer graphic");
        },showerror);

        console.log("\ndo parcel-buffered parcel intersection query..listen for callback");
    }
}

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  O W N E R   L O O K U P
//
//  Step 1: Search "NAME" field in Owners table.
//
//  This set of functions query_owners_* will query the "CAD_OWNERS" table
//  and return a featureSet (no geometries since its a table)
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function f_query_owners_init(){

    // Owners table currently has an ID of 5
    QT_owners = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/5");
    Q_owners = new esri.tasks.Query();
    Q_owners.returnGeometry = false;
    Q_owners.outFields = F_outFields.owner;
}

function f_query_owners_exec(){

    console.log("f_query_owners_exec","no vars")

    Q_owners.where = "([NAME] LIKE '%"+ dojo.byId("txtQueryOwner").value + "%')";

    QT_owners.execute( Q_owners, f_query_owners_results);
}

function f_query_owners_results( results ){

    console.log("f_query_owners_results","results", results);
    // process owner search results

    for (var i=0, il=results.features.length; i<il; i++) {

        var featureAttributes = results.features[i].attributes;
        var e_div_owner = dojo.doc.createElement("div");
        e_div_owner.id = "r_owner_"+featureAttributes["OWNID"];

        for (att in featureAttributes) {
            var e_div_owner_attrib = dojo.doc.createElement("div");
            e_div_owner_attrib.innerHTML += "<b>" + fieldAlias(att, "owner") + ":</b>  " + featureAttributes[att] + "<br />";
            e_div_owner.appendChild( e_div_owner_attrib);
        }

        var e_div_owner_tools = dojo.doc.createElement("div");
        e_div_owner_tools.innerHTML = "<a href=\"#\" onclick=\"f_query_owner_int_exec("+featureAttributes["OWNID"]+")\">Find Owner Parcels</a>";
        e_div_owner_tools.appendChild( dojo.doc.createElement("hr"));
        e_div_owner.appendChild( e_div_owner_tools);

        dojo.style(dojo.byId("dSearchResultsLoadingOwner"), "display", "block");

        dojo.byId("dSearchResultsOwner").appendChild( e_div_owner); // where to put owner results

    }

    dojo.fx.wipeOut( {node:"dLoadingSearchOwners", duration:1000} ).play();

    //tabs_toggle("SelectionPane");
}

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  O W N E R    R E L A T E D   L O O K U P  ( O W N E R   P A R C E L S )
//
//  Step 2: "Query Related Records" from intermediate table
//          with all occurences of "OID" from Step 1.
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function f_query_owner_int_init(){

    // query on the Intermediate Table - layer 8
    QT_owner_int = new esri.tasks.QueryTask( DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/8" );

    Q_owner_int = new esri.tasks.Query();
    Q_owner_int.returnGeometry = false;
}

function f_query_owner_parcels_init(){

    // query on the Intermediate using Oids - layer 1
    QT_owner_parcels = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/8");

    Q_owner_parcels = new esri.tasks.RelationshipQuery();
    Q_owner_parcels.returnGeometry = true;
    Q_owner_parcels.relationshipId = 11;
    Q_owner_parcels.outFields = F_outFields.parcel;//["PID","PAMS_PIN"]
}

function f_query_owner_int_exec(ownerid){

    console.log("f_query_owner_int_exec","ownerid", ownerid);
    // Perform relationship query on Owner table to get Parcel IDs from Intermediate Table

    GV_current_ownerid = ownerid;
    Q_owner_int.where = "[OWNERID] = "+ ownerid;
    QT_owner_int.executeForIds(Q_owner_int,f_query_owner_int_results,showerror);
}

function f_query_owner_int_results(results){


    console.log("f_query_owner_int_results","results", results);
    // this holds all the parcel intermediate RecordIds.. this is used in a RelationshipQuery on intermediate to parcel
    if(results){
        Q_owner_parcels.objectIds = [results];
        //QT_owner_parcels.executeRelationshipQuery(Q_owner_parcels,f_query_owner_parcels_results,showerror);
        QT_owner_parcels.executeRelationshipQuery(Q_owner_parcels,f_query_owner_parcels_results,showerror);
    }
    else{
        alert("No owner records were found.");
    }
}

// following will be combined with unified parcel results function
function f_query_owner_parcels_results(featureSets){

    console.log("f_query_owner_parcels_results(featureSets)");
    console.log(featureSets);

    // set global so we can select a parcel graphic to show it on the map
    //featureSet_ownerParcels = featureSets;

    // RelationshipQuery can return multiple featureSets.. use object iteration
    var type = "parcel_owners";

    var object_attr="PID";
    var s = "";

    for(featureSet in featureSets){

        // write attributes

        var graphic;
        var featureAttributes;

        for (var i=0, il=featureSets[featureSet].features.length; i<il; i++) {

            featureSet_ownerParcels = featureSets[featureSet];

            featureAttributes = featureSets[featureSet].features[i].attributes;
            graphic = featureSets[featureSet].features[i];

            graphic.setSymbol( S_feature_selection );
            graphic.infoTemplate = F_IW_templates.parcel;

            GL_parcel_owners.add(graphic);
            var GL_parcel_owner_count = GL_parcel_owners.graphics.length;

            // set header of template
            // set content of template

            var el_parcel = dojo.doc.createElement("div");
            el_parcel.id = "selOwnerParcel_"+ featureAttributes["PID"];
            el_parcel.setAttribute("class","dParcelItem");
            el_parcel.appendChild( dojo.doc.createElement("hr"));

            // create dom a element - tool to zoom to parcel
            var el_parcelToolZoomTo = dojo.doc.createElement("a");
            el_parcelToolZoomTo.setAttribute("onclick","f_feature_action(\"Zoom To\",\""+type+"\",\""+object_attr+"\",\""+ featureAttributes[object_attr] +"\")");
            el_parcelToolZoomTo.setAttribute("href","#");
            el_parcelToolZoomTo.innerHTML = "Zoom To";

            // create dom a element - tool to pan to parcel
            var el_parcelToolPanTo = dojo.doc.createElement("a");
            el_parcelToolPanTo.setAttribute("onclick","f_feature_action(\"Pan To\",\""+type+"\",\""+object_attr+"\",\""+ featureAttributes[object_attr] +"\")");
            el_parcelToolPanTo.setAttribute("href","#");
            el_parcelToolPanTo.innerHTML = "Pan To";

            // create dom a element - tool to flash parcel
            var el_parcelToolFlash = dojo.doc.createElement("a");
            el_parcelToolFlash.setAttribute("onclick","f_feature_action(\"Flash\",\""+type+"\",\""+object_attr+"\",\""+ featureAttributes[object_attr] +"\")");
            el_parcelToolFlash.setAttribute("href","#");
            el_parcelToolFlash.innerHTML = "Flash";

            var el_parcelAttribs = dojo.doc.createElement("div");
            el_parcelAttribs.setAttribute("class","dSelParcelContainer");

            for (att in featureAttributes) {
                el_parcelAttribs.innerHTML += "<b>" + fieldAlias(att, "owner") + ":</b>  " + featureAttributes[att] + "<br />";
            }

            // add all the links to the parcel container
            el_parcel.appendChild( el_parcelToolZoomTo);
            el_parcel.appendChild( el_parcelToolPanTo);
            el_parcel.appendChild( el_parcelToolFlash);
            el_parcel.appendChild( el_parcelAttribs);

            // append all the parcel tools and attributes to the specific parcel div
            dojo.byId("r_owner_" + GV_current_ownerid).appendChild( el_parcel);
        }
    }
}

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  P R O P E R T Y    L O O K U P
//
//  New query to replace individual Address, Facility, and Block/Lot Queries
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function f_query_parcel_init(){

    // query on the Parcel Feature Class - layer id 0
    QT_parcel = new esri.tasks.QueryTask( DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/0" );
    Q_parcel = new esri.tasks.Query();
    Q_parcel.returnGeometry = true;

    Q_parcel.outFields = F_outFields.parcel;
}

function f_query_parcel_exec(searchType){

    //devlogalert("f_query_parcel_exec(searchType) -> " + searchType);

    console.log("f_query_parcel_exec","searchType", searchType)
    // generate where clause from all input boxes
    // first function creates where clause for searchable fields, second is from checkboxes

    // check if this is a landuse search
    if( dojo.byId("rdo_landuse_searchSelect").checked )
    {
        // this is a landuse search
        var chk_landuses = dojo.query(".s_landuse_chk_item"),
        //landuse_count = 0,
                landuse_search = "LANDUSE_CODE  IN (";

        dojo.forEach( chk_landuses, function( landuse ){
            if ( landuse.checked ) {
                //landuse_count++;
                landuse_search += "'" + landuse.id.replace("chk_landuse_","") + "',";
            }
        });

        landuse_search = landuse_search.substring(0,landuse_search.length-1) + ")";

        landuse_search += f_query_search_extent( );

        //now run landuse query.. set callback to use f_search
        //alert(landuse_search);

        console.log("LandUse Query: " + landuse_search);

        Q_landuse.where = landuse_search;

        search_LandUseIDs = [];

        QT_landuse.execute(Q_landuse, function(results){

            // get PIDs
            // now query parcels w/ PIDs.. instead of relationshipquery using landuse OIDs
            for (var i=0, il=results.features.length; i<il; i++) {
                search_LandUseIDs.push(results.features[i].attributes["PID"]);
            }

            f_search("PID IN (" + commaListFromArray( search_LandUseIDs ) + ")");

        });
    }
    else{

        f_search("");
    }

}

function f_search( whereClause ){

    console.log("f_search", "whereClause", whereClause)

    var strListPIDs ="";

    // check if where clause exists.. if so append with AND
    if( whereClause.length > 0 ){
        strListPIDs = whereClause + " AND ";
    }

    // now set the where clause
    strWhereParcel = f_where_parcel();
    strWhereExtent = f_query_search_extent();

    if(strWhereParcel.length > 0){

        var strWhere = strListPIDs + strWhereParcel + strWhereExtent;

        console.log("Query: " + strWhere + "\n\n");
        Q_parcel.where = strWhere;

        QT_parcel.execute(Q_parcel, function(results){

            dojo.fx.wipeOut( {node:"dLoadingSearch", duration:1000} ).play();

            //f_process_results_parcel( "parcel", results);
            f_process_results_parcel_search(results);

        },showerror);

        //tabs_toggle("SelectionPane", "Search Results");
    }
    else{
        alert("You must supply search critera for this operation.\n\nPlease include any of the following:\n\n    1. Address  \n\n    2. Block\n\n    3. Lot\n\n    4. Acreage (Min and Max in search options)");
    }

}

function f_where_parcel(){

    // now check for values in search fields. include them in WHERE clause if necessary;

    /////////////////////////
    //
    // B L O C K  /  L O T
    //
    /////////////////////////

    var strWhereBlock =  strWhereLot = strWhereOldBlock = strWhereOldLot = strWhereAddress = strWhereAcres = "";

    // grab all input values
    var qBlock = dojo.byId("txtQueryBlock"),
            qLot = dojo.byId("txtQueryLot"),
            qAddress = dojo.byId("txtQueryAddress"),
            qAcresMin = dojo.byId("txtAcreageMin"),
            qAcresMax = dojo.byId("txtAcreageMax");

    // grab search option checkbox values
    var b_BlockLotOld = dojo.byId("b_searchOldBlockLot"),
            b_BlockLotExact = dojo.byId("b_searchBlockLotExact");

    // see if either block or lot is set. if so, set block and/or lot filters
    if (qBlock.value.length > 0 || qLot.value.length > 0) {

        // check if old block lot search is enabled: if so, create additonal filter

        // check to see if block has value set.. if so, create appropriate filter..
        if (qBlock.value.length > 0) {

            // check old block
            if(b_BlockLotOld.checked){
                strWhereOldBlock = (b_BlockLotExact.checked) ? "OR [OLD_BLOCK] = '" + qBlock.value + "' " : "OR [OLD_BLOCK] LIKE '%" + qBlock.value + "%' ";
            }

            // check if exact match is required. if so use =, if not use LIKE
            if(b_BlockLotExact.checked){
                strWhereBlock = "( [BLOCK] = '" + qBlock.value + "' " + strWhereOldBlock + ") ";
            }
            else{
                strWhereBlock = "( [BLOCK] LIKE '%" + qBlock.value + "%' " + strWhereOldBlock + ") ";
            }
        }
        else{
            strWhereBlock = "";
        }

        if (qLot.value.length > 0) {

            // check old lot
            if(b_BlockLotOld.checked){
                strWhereOldLot = (b_BlockLotExact.checked) ? "OR [OLD_LOT] = '" + qLot.value + "' " : "OR [OLD_LOT] LIKE '%" + qLot.value + "%' ";
            }

            strWhereLot = (qBlock.value) ? " AND " : "";

            // check if exact match is required. if so use =, if not use LIKE

            if(b_BlockLotExact.checked){
                strWhereLot += "( [LOT] = '" + qLot.value + "' " + strWhereOldLot + ") ";
            }
            else{
                strWhereLot += "( [LOT] LIKE '%" + qLot.value + "%' " + strWhereOldLot + ") ";
            }
        }
        else{
            strWhereLot = "";
        }

    }

    /////////////////////
    //
    // A D D R E S S
    //
    /////////////////////

    if( qAddress.value ){

        strWhereAddress = (strWhereBlock.length > 0 || strWhereLot.length > 0) ? " AND " : "";

        strWhereAddress += "( [PROPERTY_ADDRESS] LIKE '%" + qAddress.value + "%' ) ";
    }

    /////////////////////
    //
    //  A C R E A G E
    //
    /////////////////////

    // check if we need to inclue the Acreage filter

    if(qAcresMin.value && qAcresMin != 0){

        strWhereAcres = ( strWhereBlock.length > 0 || strWhereLot.length > 0 || strWhereAddress.length > 0 ) ? " AND " : "";

        strWhereAcres += " ( [MAP_ACRES] >= " + qAcresMin.value + " ) ";
    }

    if(qAcresMax.value && qAcresMin != 0){

        strWhereAcres += ( strWhereBlock.length > 0 || strWhereLot.length > 0 || strWhereAddress.length > 0 || strWhereAcres.length > 0) ? " AND " : "";

        strWhereAcres += " ( [MAP_ACRES] <= " + qAcresMax.value + " ) ";
    }

    // concat all where filters into
    return strWhereBlock + strWhereLot + strWhereAddress + strWhereAcres;
}

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  L A N D U S E   L O O K U P
//
//  Step 1: Search "LANDUSE_CODE" field in CAD_LANDUSE table and [MAP_ACRES] field
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function f_query_landuse_init(){

    // query on the Landuse Table - layer id 9
    QT_landuse = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/9");
    Q_landuse = new esri.tasks.Query();
    Q_landuse.returnGeometry = false;
    Q_landuse.outFields = ["PID"];

    QT_landuse_parcel = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/0");
    Q_landuse_parcel = new esri.tasks.Query();
    Q_landuse_parcel.returnGeometry = true;
    Q_landuse_parcel.outFields = F_outFields.parcel;
};

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  F A C I L I T Y  ( B U I L D I N G )   L O O K U P
//
//  Step 1: Search "FACILITY_NAME" field in Building feature class
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

//function f_query_facility_init(){
//
//    // query on the Building Feature Class - layer id 1
//    QT_facility = new esri.tasks.QueryTask( DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/1");
//    Q_facility = new esri.tasks.Query();
//    Q_facility.returnGeometry = true;
//
//    // enter additional fields in following array to include them in the results set
//    // check rest url for available fields --> http://webmaps/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/1
//    //["PID","BID","MUNICIPALITY","BUILDING_LOCATION","FACILITY_NAME"];
//
//    Q_facility.outFields = F_outFields.building;
//}
//
//function f_query_facility_exec(){
//
//    console.log("f_query_facility_exec","no vars");
//
//    var strSearchExtent = f_query_search_extent( );
//    // build query with facility name
//
//    Q_facility.where = " ([FACILITY_NAME] LIKE \"%"+ dojo.byId("txtQueryFacility").value  + "%\")"+ strSearchExtent;
//
//    QT_facility.execute(Q_facility,function(results){
//        f_process_results_parcel("facility",results);
//    },showerror);
//}

///////////////////////////////////////////////////

// add Municipality and Parcel Criteria to search
// applies to all search

function f_query_search_extent(){

    /////////////////////
    // SET MUNI Extent
    /////////////////////
    var str_where = "";

    var chk_munis = dojo.query( ".s_muni_chk_item" );

    if( chk_munis.length > 0){

        var str_munis = " AND ( [MUN_CODE] IN (";

        // loop through all checkboxes; if checked, append to the muni portion of the where clause;
        var count = 0;

        dojo.forEach( chk_munis, function( muni ){
            if (muni.checked) {
                count++;
                str_munis += "'" + muni.id.replace( "chk_muni_", "" ) + "',";
            }
        });

        str_munis += ", ) ) ";
        str_munis = str_munis.replace( ",," , "");

        if( count > 0 ){ str_where = str_munis; }
    }

    ////////////////////////
    // SET QUALIFIER Extent
    ////////////////////////

    var chk_quals = dojo.query( ".s_qual_chk_item" );

    if( chk_quals.length > 0){

        var str_quals = " AND ( [QUALIFIER] IN (";

        // loop through all checkboxes; if checked, append to the muni portion of the where clause;

        var count=0;

        dojo.forEach( chk_quals, function( qual ){

            if ( qual.checked ) {
                count++;
                str_quals += "'" + qual.id.replace("chk_qual_","") + "',";
            }
        });

        str_quals += ", ) ) ";
        str_quals = str_quals.replace( ",," ,"" );

        if( count > 0 ) str_where += str_quals;
    }
    return str_where;
}

/////////////////

function zoomToCustomFullExtent()	{
    //var CustomFullExtent = new esri.geometry.Extent( 582057.758333342, 659902.81542969, 636285.741666661, 747578.709309896, new esri.SpatialReference( { "wkid":3424 } ));
    M_meri.setExtent(njmcExtent);
}

function commaListFromArray(ary){
    var str = "";
    dojo.forEach( ary, function( el ){ str += "'" + el + "',"; });
    return str.substring( 0, str.length-1 );
}

function f_search_handler( id ){

    // set global search tool var.
    GV_searchtool_current = id;

    search_field_display( id );

    /* other options are not currently operational.. commenting block for time being
     // we can do other stuff here, depending which search tool is set

     switch (id){

     case "search_BL": console.log("search tool block-lot activated");
     break;
     case "search_ADDR":console.log("search tool address activated");
     break;
     case "search_OWNR":console.log("search tool owner activated");
     break;
     case "search_LND":console.log("search tool landuse activated");
     break;
     case "search_FAC":console.log("search tool facility activated");
     break;
     }
     */

}

// Build Municipality Checkbox Menu
function f_search_munis_build( ){

    var e_div_checkboxs = dojo.doc.createElement("div");
    e_div_checkboxs.id = "selSearchMuni";

    // set the class
    e_div_checkboxs.setAttribute("class","search_item");

    dojo.forEach( munis_json, function( muni, index){

        var e_div_container = dojo.doc.createElement("div");
        e_div_container.setAttribute("class","muniCheckRow");
        //e_div_container.id = "s_muni_"+muni.muncode;

        var e_chk = dojo.doc.createElement("input");
        e_chk.type = "checkbox";
        e_chk.id = "chk_muni_"+muni.muncode;
        e_chk.setAttribute("class","s_muni_chk_item");

        var e_lbl = dojo.doc.createElement("label");
        e_lbl.setAttribute("for", "chk_muni_"+muni.muncode);
        e_lbl.setAttribute("class", "search_muni_label");

        e_lbl.innerHTML = muni.mun;

        // add the div and the label to the container
        e_div_container.appendChild( e_chk);
        e_div_container.appendChild( e_lbl);

        e_div_container.setAttribute("title",muni.mun);

        //add the container to the main muni search container
        e_div_checkboxs.appendChild( e_div_container);

    });

    dojo.byId("search_munis").appendChild( e_div_checkboxs);
}

// Build Qualifier Checkbox Menu
function f_search_qual_build( ){

    var e_div_checkboxs = dojo.doc.createElement("div");
    e_div_checkboxs.id = "selSearchQual";

    // set the class
    e_div_checkboxs.setAttribute("class","search_item");

    dojo.forEach( quals_json, function(qual,index){

        var e_div_container = dojo.doc.createElement("div");
        e_div_container.setAttribute("class","qualCheckRow");

        var e_chk = dojo.doc.createElement("input");
        e_chk.type = "checkbox";
        e_chk.id = "chk_qual_"+qual.id;
        e_chk.setAttribute("class","s_qual_chk_item");

        var e_lbl = dojo.doc.createElement("label");
        e_lbl.setAttribute("for", "chk_qual_"+qual.id);
        e_lbl.setAttribute("class", "search_qual_label");

        e_lbl.innerHTML = qual.name;

        // add the div and the label to the container
        e_div_container.appendChild( e_chk);
        e_div_container.appendChild( e_lbl);

        e_div_container.setAttribute("title",qual.desc);

        //add the container to the main muni search container
        e_div_checkboxs.appendChild( e_div_container);

    });

    dojo.byId("search_qual").appendChild( e_div_checkboxs);
}

function f_search_landuse_build( ){

    if( typeof( landuse_json.length ) === "undefined" ){
        // console.log..
        return;
    }

    var e_div_checkboxs = dojo.doc.createElement("div");
    e_div_checkboxs.id = "selSearchLanduse";

    // set the class
    e_div_checkboxs.setAttribute("class","search_item");

    dojo.forEach( landuse_json, function( landuse, index ){

        var e_div_container = dojo.doc.createElement("div");
        e_div_container.setAttribute("class","landuseCheckRow");

        var e_chk = dojo.doc.createElement("input");
        e_chk.type = "checkbox";
        e_chk.id = "chk_landuse_"+landuse.code;
        e_chk.setAttribute("class", "s_landuse_chk_item");

        var e_lbl = dojo.doc.createElement("label");
        e_lbl.setAttribute("for", "chk_landuse_" + landuse.code );
        e_lbl.setAttribute("class", "search_landuse_label");

        e_lbl.innerHTML = landuse.name;

        // add the div and the label to the container
        e_div_container.appendChild( e_chk);
        e_div_container.appendChild( e_lbl);

        e_div_container.setAttribute("title",landuse.name);

        //add the container to the main muni search container
        e_div_checkboxs.appendChild( e_div_container);

    });

    dojo.byId("search_landuse").appendChild( e_div_checkboxs );
}

// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
//
//  C S S  /  L A Y O U T   J A V A S C R I P T
//
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

function toggle_visibility( id ) {

    var el = dojo.byId( id );

    if( el.style.display == "block") el.style.display = "none";
    else el.style.display = "block";

    console.log("FUNCTION toggle visibility.. id ->",id)
}

function hide_visibility( id ){ dojo.style( id, "display", "none"); }

function show_visibility( id ){ dojo.style( id, "display", "block"); }

function tabs_toggle(id){

    var panes = ["MapPane", "SearchPane", "SelectionPane", "HelpPane"],
            tabs = ["LayersToggle", "SearchTab", "SelectionTab", "HelpTab"], // ResultsTab renamed SelectionTab
            selectedTab;

    dojo.forEach( panes, function( pane ){ hide_visibility( pane ); });

    show_visibility(id);

    // shade active tab
    dojo.forEach( tabs, function( tab ){

        dojo.style(tab, {
            backgroundColor:"#FFFFFF",
            fontWeight:"normal",
            paddingBottom :"0"
        });
    });

    switch (id){
        case "MapPane":
            selectedTab = "LayersToggle";
            break;
        case "SearchPane":
            selectedTab = "SearchTab";
            break;
        case "SelectionPane":
            selectedTab = "SelectionTab";
            break;
        case "HelpPane":
            selectedTab = "HelpTab";
            break;
    }

    //  dojo.byId(selectedTab).style.backgroundColor = "#F0F0F0";
    // dojo.byId(selectedTab).style.fontWeight = "bold";
    // dojo.byId(selectedTab).style.paddingBottom = "1px";

    dojo.style(selectedTab, {
        backgroundColor :"#F0F0F0",
        fontWeight :"bold",
        paddingBottom :"1px"
    });


}

///////////////////////////////////
//
// WINDOW ADJUSTMENTS
//bk
//////////////////////////////////
function resize_content_pane() {

    //get window height
    var theHeight = dojo.window.getBox().h;
    var DivHeight = theHeight - 145;

    var tabs = ["MapPane", "SearchPane", "SelectionPane", "HelpPane"];

    dojo.forEach( tabs, function( tab ){
        //CLOGconsole.log("tab",tab);
        dojo.style( tab , "height", DivHeight + "px");
    });
}

function hide_search_boxes(){

    // set all search boxes display to none -hide it
    dojo.forEach(SearchDivs,function(searchDiv){
        dojo.style(searchDiv,"display","none");
    });
}

function search_field_display( id ){

    //hide search boxes
    dojo.forEach(SearchDivs,function(searchDiv){
        dojo.style(searchDiv,"display","none");
    });

    //show selected search
    dojo.style(id,"display","block");
}

function selection_tab_display( id ){

    //hide search boxes
    dojo.forEach(SelectionDivs,function(selectionDiv){
        dojo.style(selectionDiv,"display","none");
    });

    //show selected search
    dojo.style(id,"display","block");
}


// BK MENU Stuff
function coll_mnu(){
    hide_visibility("framecontent");

    // set map style left 20px
    dojo.style( dojo.byId("map"), "left", "20px" );

    show_visibility("expand");

    // resize and reposition map
    M_meri.resize();
    M_meri.reposition();
}

// BK MENU Stuff
function expnd_mnu(){

    show_visibility( "framecontent" );

    dojo.style("map","left", "320px");

    hide_visibility( "expand" );

    // resize and reposition map
    M_meri.resize();
    M_meri.reposition();
}

function showerror( error ){
    console.log("ERROR", error, error.toString() );
}

// PARCEL SELECTION RESULTS

function f_result_detail( type, target_el, pid, oid ){

    alert("F result details!?  if you see this, updates are needed")
    // view more button functionality

    // type = parcel
    // el = detail_selParcel_41553

    //dojo.byId(target_el).appendChild( );

    // get image
    // get zoning
    // get owners

    // query on the Landuse Table - layer id 9
    var QT_det_landuse = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/9");
    var Q_det_landuse = new esri.tasks.Query();
    Q_det_landuse.returnGeometry = false;
    Q_det_landuse.outFields = ["LANDUSE_CODE","MAP_ACRES"];
    Q_det_landuse.where = "PID = " + pid;

    var QT_det_zoning = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/7");
    var Q_det_zoning = new esri.tasks.Query();
    Q_det_zoning.returnGeometry = false;
    Q_det_zoning.outFields = ["ZONE_CODE","MAP_ACRES"];
    Q_det_zoning.where = "PID = " + pid;

    var QT_det_owners_int = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/8");
    var Q_det_owners_int = new esri.tasks.Query();
    Q_det_owners_int.returnGeometry = false;
    Q_det_owners_int.where = "PID = " + pid;

    var QT_det_owners = new esri.tasks.QueryTask(DynamicLayerHost + "/ArcGIS/rest/services/Parcels/NJMC_Parcels_2011/MapServer/8");
    var Q_det_owners = new esri.tasks.RelationshipQuery();
    Q_det_owners.relationshipId = 10;
    Q_det_owners.returnGeometry = false;
    Q_det_owners.outFields = ["NAME","ADDRESS","CITY_STATE","ZIPCODE"];

    dojo.style( dojo.byId("detail_view_a_"+pid), "display", "none");

    //view more LANDUSE
    QT_det_landuse.execute(Q_det_landuse, function(results){

        var el_layer = dojo.doc.createElement("div");
        //el_layer.id = "identLayer_" + identifyResult.layerName;
        el_layer.setAttribute("class","details");

        for (var i=0, il=results.features.length; i<il; i++) {

            var featureAttributes = results.features[i].attributes;
            var output = "<ul class=\"ResultList SelectionResult\">";

            for (attr in featureAttributes) {

                output += FormatResult(attr, results.features[i].attributes[attr], "selection selection_more");

            }
            output += "</ul>";
            el_layer.innerHTML += output;
            dojo.byId(target_el).appendChild( el_layer);
        }

        // loop through all attributes for this div

    },function(error){console.log(error)});

    //view more ZONING
    QT_det_zoning.execute(Q_det_zoning, function(results){

        var el_layer = dojo.doc.createElement("div");
        el_layer.setAttribute("class","details");

        for (var i=0, il=results.features.length; i<il; i++) {

            var featureAttributes = results.features[i].attributes;
            var output = "<ul class=\"ResultList SelectionResult\">";
            for (attr in featureAttributes) {

                output += FormatResult(attr, results.features[i].attributes[attr], "selection selection_more");

            }
            output += "</ul>";
            el_layer.innerHTML += output;
            dojo.byId(target_el).appendChild( el_layer);
        }
    },showerror);

    //view more OWNERS
    QT_det_owners_int.executeForIds(Q_det_owners_int,function(ids){

        Q_det_owners.objectIds = [ids];

        QT_det_owners.executeRelationshipQuery(Q_det_owners,function(featureSets){

                    for(featureSet in featureSets){

                        // write attributes

                        var el_layer = dojo.doc.createElement("div");
                        el_layer.setAttribute("class","details");

                        var featureAttributes;

                        for (var i=0, il=featureSets[featureSet].features.length; i<il; i++) {

                            featureAttributes = featureSets[featureSet].features[i].attributes;

                            var el_layer_attr = dojo.doc.createElement("div");
                            el_layer_attr.setAttribute("class","detail_layer_attr");

                            var el_parcelAttribs = dojo.doc.createElement("div");
                            el_parcelAttribs.setAttribute("class","dSelParcelContainer");

                            var output = "<ul class=\"ResultList SelectionResult\">";

                            for (attr in featureAttributes) {
                                output += FormatResult(attr, featureAttributes[attr], "selection selection_more");
                            }
                            output += "</ul>";

                            el_layer.innerHTML += output;

                            // add all the links to the primary parcel container
                            //el_layer.appendChild( el_parcelAttribs);

                            dojo.byId(target_el).appendChild( el_layer);
                        }
                    }
                }
                ,showerror);

    },showerror);
};


function f_summarize_totals(graphics, summaryType, targetDiv){

    // summarize totals for search results, selected parcels, and buffer results

    console.log("f_summarize_totals(graphics, summaryType, targetDiv)");
    console.log(graphics, summaryType, targetDiv);
    // calculate acreage and counts for searches, selections, and buffers
    // creates export to excel link,

    var fucnt,
            totalAcres = 0,
            featureCount = graphics.length === "undefined" ? 0 : graphics.length,
            field = "MAP_ACRES", // attribute field
            str_pid_list = "",
            featureInfo,featureInfoB,
            exportText,
            target = dojo.byId(targetDiv);

    switch(summaryType){

        case "search":
            featureInfoB = " result" + (featureCount > 1 ? "s":"") + " found.";
            exportText = "Export search results to excel.";
            break;

        case "selection":
            featureInfoB = " parcel" + (featureCount > 1 ? "s":"") + " selected.";
            exportText = "Export Map &amp; Search Selections to excel.";
            break;

        case "buffer":
            featureInfoB = " parcel" + (featureCount > 1 ? "s":"") + " selected from buffer."
            exportText = "Export Buffer selected parcels to excel."
            break;
    }

    dojo.forEach( graphics, function( graphic ){
        totalAcres += graphic.attributes[ field ];

        str_pid_list += graphic.attributes[ "PID" ] + ",";
    });

    // trim tailing ,
    str_pid_list = str_pid_list.substring( 0, str_pid_list.length - 1 );

    // create summary totals div and add content
    var e_summary = dojo.doc.createElement("div");
    e_summary.innerHTML =  featureCount + " "+ featureInfoB + "  Total Acres: " + (Math.round( totalAcres * 100 ) / 100) + "";

    var e_export = dojo.doc.createElement("a")
    e_export.innerHTML = "Export to Excel: (" + featureCount + " item" + (featureCount > 1 ? "s" : "") +")";
    e_export.setAttribute( "href", "http://webmaps.njmeadowlands.gov/municipal/export_parcel_owners.php?excel=1&layers=Owner&pids=" + str_pid_list);
    e_export.setAttribute( "style", "padding-top:6px;display:block");

    //var e_zoomToExtent = dojo.doc.createElement("div");
    //	e_zoomToExtent.innerHTML = "Zoom to Result Extent";
    //	e_zoomToExtent.setAttribute("onclick", function( graphics ){ f_zoomToGraphicsExtent( gs );} );

    var e_exportSummary = dojo.doc.createElement("div");
    e_exportSummary.appendChild( e_summary );
    e_exportSummary.appendChild( e_export );
    //e_exportSummary.appendChild( e_zoomToExtent );

    dojo.empty(target);
    target.appendChild( e_exportSummary );

};

function f_map_graphics_clear(){

    // clear selection graphics
    GL_parcel_selection.clear();

    GL_buffer_parcel.clear();
    GL_buffer_buffer.clear();
    GL_buffer_selected_parcels.clear();


    // clear search graphics
    GL_query_parcel.clear();

    //GL_query_facility.clear();
    GL_parcel_owners.clear();

    // clear any random map graphics
    M_meri.graphics.clear();

    // reset featureSet selection collections
    fSet_selected_parcels = [];
    fSet_buffered_parcels = [];

    // clear divs and other elements
    dojo.forEach([
        //"r_map_search",
        "r_map_selection",
        "r_map_buffer",

        "dIdentifyResults",
        "dSearchResultsSummary",
        "dSearchResultsOwner",
        "tblBodySearchResultsParcel",
        "Results_ERIS",
        "Links_ERIS"]
            ,function(element){

                dojo.empty(dojo.byId(element));

            });

    dojo.forEach(["Buffer","Map"]
            ,function(element){

                dojo.byId("dSelectionSummary" + element).innerHTML = "No selections have been made from the " + element + " tab.";

            });


    // reset summarize in tabs
    dojo.byId("SearchTab").query("a")
            .attr("innerHTML","Search");

    dojo.byId("SelectionTab").query("a")
            .attr("innerHTML","Selections");

//    dojo.query("#SearchTab").query("a")
//            .attr("innerHTML","Search");
//
//    dojo.query("#SelectionTab").query("a")
//            .attr("innerHTML","Selections");

//    //dojo.byId("dSearchResultsParcel").innerHTML = "";

    //f_tabTotalsReset();
};

// update selection summary and listing

function f_selectionUpdateSearchTotals(GL, targetDiv){

    //devlog console.log("f_selectionUpdateSearchTotals(GL, targetDiv -> " + GL.id + " - " + targetDiv );
    //devlog console.log("Click Type:",clickType, "graphics", graphics );

    var totalAcres = 0,
            field = "MAP_ACRES",
            str_pid_list = "";

    dojo.forEach( GL.graphics, function( graphic ){
        totalAcres += graphic.attributes[ field ];

        //if( type=="buffer" ){
        str_pid_list += graphic.attributes[ "PID" ] + ",";
    });

    var e_summary = dojo.doc.createElement("div");

    if(GL.graphics.length==0){
        console.log("line:3796");
    }
    e_summary.innerHTML =  GL.graphics.length + " "  + ( GL.graphics.length == 1 ? " parcel was found. " : "parcels were found." ) +  "( "+ Math.round( totalAcres * 100 ) / 100 + " acres )";

    var e_export = dojo.doc.createElement("a")
    e_export.innerHTML = "Export Results to Excel";
    e_export.setAttribute( "href", "http://webmaps.njmeadowlands.gov/municipal/export_parcel_owners.php?excel=1&layers=Owner&pids=" + str_pid_list.substring( 0, str_pid_list.length - 1 ));
    e_export.setAttribute( "style", "padding-top:6px;display:block");

    //var e_zoomToExtent = dojo.doc.createElement("div");
    //	e_zoomToExtent.innerHTML = "Zoom to Result Extent";
    //	e_zoomToExtent.setAttribute("onclick", function( graphics ){ f_zoomToGraphicsExtent( gs );} );

    var e_exportSummary = dojo.doc.createElement("div");
    e_exportSummary.appendChild( e_summary );
    e_exportSummary.appendChild( e_export );
    //e_exportSummary.appendChild( e_zoomToExtent );

    var resultsSummary = dojo.byId(targetDiv);
    dojo.empty(resultsSummary);
    resultsSummary.appendChild( e_exportSummary );

};

function f_selectionUpdateSearch(GL, targetDiv){

    //devlog console.log("f_selectionUpdateSearch(GL, targetDiv) -> " + GL.id + " - " + targetDiv );
    //var GL = GL_parcel_selection;

    var target_div = dojo.byId(targetDiv),
            type = "selectionSearch",
            object_attr = "OID";

    //now loop through graphics and add to results
    for ( var i=0, il = GL_parcel_selection.graphics.length; i < il; i++) {

        var featureAttributes = GL_parcel_selection.graphics[i].attributes;
        var graphic = GL_parcel_selection.graphics[i];

        //if the layer type is buffer, append the PID list for the export link
        //if( type=="buffer" ){
        //	str_pid_list += featureAttributes[ "PID" ] + ",";
        //}

        graphic.setSymbol( S_feature_selection );
        graphic.infoTemplate = F_IW_templates.searchParcel;

        // GL_container.add( graphic );

        // var GL_count = GL_container.graphics.length;

        // show all Parcel Attributes.. // show link to parcel layer // set header of template // set content of template

        // create container element
        var el_parcel = dojo.doc.createElement("div");
        el_parcel.id = "dSelSearch_" + featureAttributes[object_attr];
        el_parcel.setAttribute("class","dParcelItem");

        // prepend content with a horizontal rule
        el_parcel.appendChild( dojo.doc.createElement("hr") );

        var el_featureToolRemove = dojo.doc.createElement("a");
        el_featureToolRemove.setAttribute("onclick", "f_feature_action(\"remove\",\"" + type + "\",\"" + object_attr + "\",\"" + featureAttributes[ object_attr ] +"\")");
        el_featureToolRemove.setAttribute("href","#");
        el_featureToolRemove.innerHTML = "Remove";

        // create dom a element - tool to zoom to parcel
        var el_featureToolZoomTo = dojo.doc.createElement("a");
        el_featureToolZoomTo.setAttribute( "onclick", "f_feature_action(\"zoomTo\",\"" + type + "\",\"" + object_attr + "\",\"" + featureAttributes[ object_attr ] + "\")");
        el_featureToolZoomTo.setAttribute( "href", "#");
        el_featureToolZoomTo.innerHTML = "Zoom To";

        // create dom a element - tool to pan to parcel
        var el_featureToolPanTo = dojo.doc.createElement("a");
        el_featureToolPanTo.setAttribute( "onclick", "f_feature_action(\"panTo\",\"" + type + "\",\"" + object_attr + "\",\"" + featureAttributes[ object_attr ] + "\")");
        el_featureToolPanTo.setAttribute("href","#");
        el_featureToolPanTo.innerHTML = "Pan To";

        // create dom a element - tool to flash parcel
        var el_featureToolFlash = dojo.doc.createElement("a");
        el_featureToolFlash.setAttribute("onclick","f_feature_action(\"flash\",\"" + type + "\",\"" + object_attr + "\",\""+ featureAttributes[ object_attr ] + "\")");
        el_featureToolFlash.setAttribute("href","#");
        el_featureToolFlash.innerHTML = "Flash";

        // create dom a element - tool to link to print map
        var el_featureToolPrint = dojo.doc.createElement("a");
        //el_featureToolFlash.setAttribute("onclick","f_feature_action("print",""+type+"",""+object_attr+"",""+ featureAttributes[object_attr] +"")");
        el_featureToolPrint.setAttribute( "href", printMapLink + featureAttributes[ object_attr ] );
        el_featureToolPrint.setAttribute( "target", "_blank" );
        el_featureToolPrint.innerHTML = "Print";

        // create dom a element - tool to view owners
        //var el_featureToolOwners = dojo.doc.createElement("a");
        //el_featureToolOwners.setAttribute("onclick","f_parcel_selection_owners(""+type+"",""+ featureAttributes["PID"] +"")");
        //el_featureToolOwners.setAttribute("href","#");
        //el_featureToolOwners.innerHTML = "View Owners";

        var el_featureAttribs = dojo.doc.createElement("div");
        el_featureAttribs.setAttribute( "class", "dSelParcelContainer" );

        // check if image is there
        //if so, create img

        // spit out attributes.  can use a template here eventually.. just bold and show field contents for now
        var output = "<ul class=\"ResultList SelectionResult\">";
        for ( attr in featureAttributes ) {
            output +=  FormatResult( attr, featureAttributes[ attr ], "selection" );
        }
        output += "</ul>";
        el_featureAttribs.innerHTML += output;

        // create view more details link

        var el_viewMoreDiv = dojo.doc.createElement("div");
        el_viewMoreDiv.setAttribute("class","dSummaryViewMore")
        el_viewMoreDiv.id = "detail_" + "dSelSearch_" + "_" + featureAttributes[object_attr];

        var el_viewMoreToggle = dojo.doc.createElement("div");
        el_viewMoreToggle.setAttribute("class","dSummaryToggle");

        var el_viewMoreToggleLink = dojo.doc.createElement("a");
        el_viewMoreToggleLink.id="detail_view_a_"+featureAttributes[object_attr];
        el_viewMoreToggleLink.setAttribute("href","#");
        el_viewMoreToggleLink.innerHTML = "-- View More --";
        el_viewMoreToggleLink.setAttribute("onclick","f_result_detail(\"parcel\",\""+el_viewMoreDiv.id+"\"," + featureAttributes[object_attr] + "," + featureAttributes["oid"] +")");

        // add anchor to toggle div
        el_viewMoreToggle.appendChild( el_viewMoreToggleLink );

        // add toggle div to View More container
        el_viewMoreDiv.appendChild( el_viewMoreToggle );

        // add all the links to the primary parcel container
        el_parcel.appendChild( el_featureToolRemove );
        el_parcel.appendChild( el_featureToolZoomTo );
        el_parcel.appendChild( el_featureToolPanTo );
        el_parcel.appendChild( el_featureToolFlash );
        el_parcel.appendChild( el_featureToolPrint );
        el_parcel.appendChild( el_featureAttribs );
        el_parcel.appendChild( el_viewMoreDiv );

        //el_parcel.appendChild( el_featureToolOwners);
        // no ownID is available, so we"ll need to create an additional owner search using parcel as enterance"
        //<a href="javascript:query_owner_int_exec("+feature.attributes["OWNID"]+")">view owner parcels</a>:<hr />

        //dojo.byId("r_search_" + GV_current_ownerid).appendChild( el_parcel);

        // if the type is a buffer, we will add the export to excel link

        dojo.byId( target_div ).appendChild( el_parcel );
    }
};

function f_zoomToGraphicsExtent( gs ){

    M_meri.setExtent( esri.graphicsExtent( gs ));

};

// Toolbar - Navigation Event Handler Callback function
function f_toolbar_nav_zoom_in(){
    f_toolbar_select("nav_zoom_in");
    navToolbar.activate( esri.toolbars.Navigation.ZOOM_IN );
}

function f_toolbar_nav_zoom_out(){
    f_toolbar_select("nav_zoom_out");
    navToolbar.activate( esri.toolbars.Navigation.ZOOM_OUT);
}

function f_toolbar_nav_zoom_fullext(){
    zoomToCustomFullExtent();
}

function f_toolbar_nav_pan(){
    f_toolbar_select("nav_pan");
    tool_selected = "pan";
    M_meri.enableMapNavigation();
    navToolbar.activate( esri.toolbars.Navigation.PAN );
}

function f_toolbar_nav_identify(){
    f_toolbar_reset();
    f_toolbar_select("nav_identify");
    navToolbar.activate( esri.toolbars.Navigation.PAN );
    tool_selected = "identify";
    tabs_toggle( "SelectionPane" );
}

function f_toolbar_nav_btn_select(){
    f_toolbar_reset();
    f_toolbar_select("nav_btn_select");
    navToolbar.activate( esri.toolbars.Navigation.PAN );
    tool_selected="select";
    tabs_toggle("SelectionPane");
    dojo.style("dBufferTool","display","block");
}

function f_toolbar_nav_measure(){
    f_toolbar_reset();
    f_toolbar_select("nav_measure");
    navToolbar.deactivate();
    measurementDijit.setTool("location",true);
    tool_selected = "measure";
    tabs_toggle( "SelectionPane" );
    show_visibility( "dMeasureWrap" );
}


function mapInitialize( ) {

    //resize side content pane area
    resize_content_pane();

    // create municipality, qualifier, and land use contents
    f_search_munis_build( );

    f_search_qual_build( );

    f_search_landuse_build( );

    // define custom extent for NJMC
    njmcExtent = new esri.geometry.Extent({
        xmin:566663,
        ymin:664051,
        xmax:652186,
        ymax:747704,
        spatialReference:{ "wkid":3424 }
    })

    // initialize map object, setting spatial reference and other properties
    M_meri = new esri.Map( "map", {
        logo: false,
        nav: true,
        navigationMode: "css-transforms", //  'classic'
        extent: njmcExtent,
        sliderStyle:"large",
        force3DTransforms: true,
        navigationMode: "css-transforms"
    });

    // define scale dijit and attach it at bottom left
    scalebarDijit = new esri.dijit.Scalebar( {map: M_meri, scalebarUnit:"english", attachTo:"bottom-left"} );

    // set image service layer for basemap imagery
    IL_basemap = new esri.layers.ArcGISImageServiceLayer( DynamicLayerHost + "/ArcGIS/rest/services/Imagery/IMG_2009_C/ImageServer");

    // set dynamic layer for MunicipalMap_live
    LD_base = new esri.layers.ArcGISDynamicMapServiceLayer( DynamicLayerHost + "/ArcGIS/rest/services/Municipal/MunicipalMap_live/MapServer",{opacity:0.8});

    // set dynamic layer for flooding
    LD_flooding = new esri.layers.ArcGISDynamicMapServiceLayer( DynamicLayerHost + "/ArcGIS/rest/services/Flooding/Flooding_Scenarios/MapServer",{opacity:0.65});


    // GRAPHICS LAYERS
    // init graphics layers for parcel, land use, and owners to hold queries graphic results
    GL_query_parcel = new esri.layers.GraphicsLayer( {opacity:0.60} ); // search results

    GL_parcel_owners = new esri.layers.GraphicsLayer( {opacity:0.60} );

    //GL_query_facility = new esri.layers.GraphicsLayer( {opacity:0.60} );

    // init graphics layer to hold parcel selections (result of map click)
    GL_parcel_selection = new esri.layers.GraphicsLayer( {opacity:0.60} );

    // init graphics layers for buffer parcel, buffer graphic, and buffer selected parcels
    GL_buffer_parcel = new esri.layers.GraphicsLayer( {opacity:0.60} );
    GL_buffer_buffer = new esri.layers.GraphicsLayer( {opacity:0.60} );
    GL_buffer_selected_parcels = new esri.layers.GraphicsLayer( {opacity:0.60} );

    // add all map layers.. new in 3.2 *** layer presedence is based on array position
    M_meri.addLayers( [ IL_basemap, LD_base, LD_flooding ] );

    // add all graphics layers
    M_meri.addLayer( GL_parcel_selection );
    M_meri.addLayer( GL_parcel_owners );
    M_meri.addLayer( GL_buffer_selected_parcels );
    M_meri.addLayer( GL_buffer_parcel );
    M_meri.addLayer( GL_buffer_buffer );
    M_meri.addLayer( GL_query_parcel );

    // resize the info window
    M_meri.infoWindow.resize(400,300);

    // create the geometry service object
    GS_parcel_selection_buffer = new esri.tasks.GeometryService( DynamicLayerHost + "/ArcGIS/rest/services/Map_Utility/Geometry/GeometryServer" );

    // set up map once the esri map object has loaded
    dojo.connect( M_meri, "onLoad", function( map ){

        console.log("Map loaded");

        // call all query initialization functions.
        f_query_parcel_init( );
        f_query_landuse_init( );
        //f_query_facility_init( );
        f_query_owners_init( );

        f_query_owner_int_init( );
        f_query_owner_parcels_init( );
        f_parcel_selection_init( );
        f_parcel_buffer_init( );

        f_map_identify_init( );

        // set the map navigation toolbar
        navToolbar = new esri.toolbars.Navigation( M_meri );

        //overviewMapDijit = new esri.dijit.OverviewMap( { map: M_merp, visible:false } );
        //overviewMapDijit.startup();

        // set and initialize the measurement dijit
        measurementDijit = new esri.dijit.Measurement( { map: map }, dojo.byId( 'dMeasureTool' ) );
        measurementDijit.startup();


        // set all selection format objects
        // esri.symbol.SimpleFillSymbol(style, outline, color)
        // new dojo.Color([255,0,0,0.25]) R,G,B,transparency

        S_feature_selection = new esri.symbol.SimpleFillSymbol(
                esri.symbol.SimpleFillSymbol.STYLE_SOLID,
                new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASHDOT, new dojo.Color([255,0,0]), 2),
                new dojo.Color([200,200,200,0.5])
                //new dojo.Color([255,255,0,0.5])
        );

        S_buffer_parcel = new esri.symbol.SimpleFillSymbol(
                esri.symbol.SimpleFillSymbol.STYLE_SOLID,
                new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new dojo.Color([100,100,100]), 3),
                new dojo.Color([255,0,0,0.20])
        );

        S_buffer_buffer = new esri.symbol.SimpleFillSymbol(
                esri.symbol.SimpleFillSymbol.STYLE_SOLID,
                new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new dojo.Color([100,100,100]), 3),
                new dojo.Color([255,0,0,0.20])
        );

        S_buffer_selected_parcels = new esri.symbol.SimpleFillSymbol(
                esri.symbol.SimpleFillSymbol.STYLE_SOLID,
                new esri.symbol.SimpleLineSymbol("dashdot", new dojo.Color([255,0,0]), 2),
                new dojo.Color([255,255,0,0.25])
        );

        S_feature_flash = new esri.symbol.SimpleFillSymbol(
                esri.symbol.SimpleFillSymbol.STYLE_SOLID,
                new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([98,194,204]), 2),
                new dojo.Color([98,194,204,0.5])
        );

        // allow the map to show up after it is loaded. then hide the loading dialog
        setTimeout( function(){ loadingDialog.hide();}, 1000 );

    });

    ////////  end on map Load

    // when the dynamic baselater is loaded, fire the layer list creation
    dojo.connect( LD_base, "onLoad", function(){ f_layer_list_build( )});

    // after the imagery layer is loaded, build the imagery list
    dojo.connect( IL_basemap, "onLoad", function(){ f_imagery_list_build( )});

    // after all the map layers are loaded, fire this. used primarily for development. BK to comment out if desired
    dojo.connect( M_meri, "onLayersAddResult", function( ){

        console.log("All Layers have been added.");

    });

    // fire a custom resize function when map is forced to resize
    dojo.connect( dojo.byId("map"), "resize", function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout( function( ) {
            M_meri.resize();
            M_meri.reposition();
            console.log("resize map");
        }, 500);
    });


    // Toolbar - Navigation Event Handlers
    // define event handlers and callback function for toolbar items

    dojo.connect( dojo.byId("nav_zoom_in"), "onclick", f_toolbar_nav_zoom_in );
    dojo.connect( dojo.byId("nav_zoom_out"), "onclick", f_toolbar_nav_zoom_out);
    dojo.connect( dojo.byId("nav_zoom_fullext"), "onclick", f_toolbar_nav_zoom_fullext);
    dojo.connect( dojo.byId("nav_zoom_prev"), "onclick", function( ) { navToolbar.zoomToPrevExtent();  });
    dojo.connect( dojo.byId("nav_zoom_next"), "onclick", function( ) { navToolbar.zoomToNextExtent(); });
    dojo.connect( dojo.byId("nav_pan"), "onclick", f_toolbar_nav_pan);
    dojo.connect( dojo.byId("nav_identify"), "onclick", f_toolbar_nav_identify);
    dojo.connect( dojo.byId("nav_btn_select"), "onclick", f_toolbar_nav_btn_select);
    dojo.connect( dojo.byId("nav_measure"), "onclick", f_toolbar_nav_measure);
    dojo.connect( dojo.byId("nav_btn_erase"), "onclick", f_map_graphics_clear );

    // non map click events
    // buffer
    dojo.connect( dojo.byId("aBufferParcelExec"), "onclick", f_multi_parcel_buffer_exec );



    // Tab Events
    dojo.connect( dojo.byId( "LayersToggle" ), "onclick", function( ) {
        tabs_toggle( "MapPane" );
    });

    dojo.connect( dojo.byId("SearchTab"), "onclick", function( ) {
        tabs_toggle( "SearchPane" );
    });

    dojo.connect( dojo.byId("SelectionTab"),"onclick", function( ) {
        tabs_toggle("SelectionPane");
    });

    dojo.connect( dojo.byId("HelpTab"), "click", function( ) {
        tabs_toggle("HelpPane");
    });


    // fire when SEARCH parcels button is clicked
    dojo.connect( dojo.byId( "i_btn_search_parcels" ), "click", function( ) {

        // turn on loading div
        dojo.style("dLoadingSearch", "display","block");

        // check search inputs.. if default, set focus to address
        if(

                dojo.byId("txtQueryAddress").value == "" &&
                dojo.byId("txtQueryBlock").value == "" &&
                dojo.byId("txtQueryLot").value == "" &&
                dojo.byId("txtAcreageMin").value == "0" &&
                dojo.byId("txtAcreageMax").value == "1000"){

            dojo.byId("txtQueryAddress").focus();
            setTimeout("dojo.style('dLoadingSearch', 'display','none')",1000);
        }
        else{
            dojo.style("dLoadingSearch", "display","block");
            f_query_parcel_exec("search");
        }

    });

    // fire when OWNERS parcels button is clicked
    dojo.connect( dojo.byId( "i_btn_search_owners" ), "click", function( ) {

        // click handler for the property owner search

        dojo.style("dLoadingSearchOwners", "display", "block");

        f_query_owners_exec();
        //f_query_owners_Search_exec();

    });


    // search filters

    // fire when municipality filter is triggered
    dojo.connect( dojo.byId( "rdo_muni_searchSelect" ), "onclick", function(){
        dojo.fx.wipeIn( {node:"search_munis", duration:1000} ).play();
    });

    // add event listeners to the Radio Buttons for municipality filter
    dojo.connect( dojo.byId("rdo_muni_searchAll"), "onclick",function( ) {
        dojo.fx.wipeOut( {node:"search_munis", duration:1000} ).play();
        dojo.query(".s_muni_chk_item").forEach( function( muni ){
            dojo.removeAttr( dojo.byId( muni.id ), "checked");
            muni.setAttribute( "value", "off" );
            muni.checked = false;
        });
    });

    // add event listeners to the Radio Buttons for qualifier filter
    dojo.connect(dojo.byId("rdo_landuse_searchAll"),"onclick",function( ) {
        dojo.fx.wipeOut({node:"search_landuse",duration:1000}).play();
        dojo.query(".s_landuse_chk_item").forEach(function(landuse){
            dojo.removeAttr(dojo.byId(landuse.id),"checked");
            landuse.setAttribute("value","off");
            landuse.checked = false;
        });
    });

    dojo.connect(dojo.byId("rdo_qual_searchSelect"),"onclick",function( ) {
        dojo.fx.wipeIn({node:"search_qual",duration:1000}).play();
    });

    // add event listeners to the Radio Buttons for qualifier filter
    dojo.connect(dojo.byId("rdo_qual_searchAll"),"onclick",function( ) {
        dojo.fx.wipeOut({node:"search_qual",duration:1000}).play();
        dojo.query(".s_qual_chk_item").forEach(function(qual){
            dojo.removeAttr(dojo.byId(qual.id),"checked");
            qual.setAttribute("value","off");
            qual.checked = false;
        });
    });

    dojo.connect(dojo.byId("rdo_landuse_searchSelect"),"onclick", function( ) {
        dojo.fx.wipeIn({node:"search_landuse",duration:1000}).play();
    });

    dojo.connect(dojo.byId("i_search_parcel_selectDeselect"), "click", function(what){

        var el_checkbox = dojo.byId("i_search_parcel_selectDeselect")
        console.log("what",what,el_checkbox,"attr", dojo.attr(el_checkbox, "checked"));

        if( dojo.attr(el_checkbox, "checked")){

            dojo.query(".searchParcelCheckbox").forEach(function(el_tr_checkbox){
                dojo.attr(el_tr_checkbox, "checked", true)
                console.log("searchParcelCheckbox",el_tr_checkbox);
            });

        }else{

            dojo.query(".searchParcelCheckbox").forEach(function(el_tr_checkbox){
                dojo.attr(el_tr_checkbox, "checked", false)
                console.log("searchParcelCheckbox",el_tr_checkbox);
            });
        }
    });



    // set event for search filters click
    dojo.connect(dojo.byId("dSearchFilterToggle"), "onclick", function(){

        var el = dojo.byId("dSearchFilters"),
                el_toggle = dojo.byId("dSearchFilterToggle");


        if(dojo.hasClass(el,"filterOff")){
            dojo.fx.wipeIn( {node:el, duration:1000} ).play();
            dojo.removeClass(el,"filterOff");
            el_toggle.innerHTML = "Search Options &amp; Filters (-)";
        }
        else{
            dojo.fx.wipeOut( {node:el, duration:500}).play();
            dojo.addClass(el,"filterOff");
            el_toggle.innerHTML = "Search Options &amp; Filters (+)";
        }


    });

    // set the Help Pane as the Default tab
    tabs_toggle("HelpPane");

//    // some dom manipulation
//    var nodeSelectionTabs = dojo.byId("SelectionPane");
//    var nodeSelectionTabsWidth = +(dojo.position(nodeSelectionTabs).w) / 3;
//
//    console.log("search menu element", nodeSelectionTabs, nodeSelectionTabsWidth);
//
//    dojo.query(".selectionTab").forEach(function(node){
//        node.innerHTML = "Something";
//
//    }).style("width", nodeSelectionTabsWidth);// + "px")
}
//end of map init


// Dependency Loading Function
function loadContinue( ) {
    if( dependencies["landuse"].isLoaded && dependencies["legend"].isLoaded ){
        //initialize map
        mapInitialize( );
    }
}

////////////////////////////////////////////////
//
// ERIS FUNCTIONS
//
/////////////////////////////////////////////////

//ERIS LOGIN
function ERISLogin() {
    // Get the result node
    var signInResultNode = dojo.byId("signInResultNode");
    var signInForm = dojo.byId("signInForm");
    // Using dojo.xhrGet, as very little information is being sent
    dojo.xhrPost({
        // The URL of the request
        url: "ERIS/authenticate.php",
        // Form to send
        form: dojo.byId("signInFormNode"),
        // The success callback with result from server
        load: function(loginResponse) {
            dojo.style(signInResultNode,"display","block");

            if(loginResponse == "true"){
                //hide login buttons if login was successful
                dojo.style(signInForm,"display","none");
                signInResultNode.innerHTML = "You are now logged in";
                window.location.reload(true); //reloads app since ERIS is a lot
            }
            else{
                signInResultNode.innerHTML = "Your password or username did not match.";
            }
        },
        // The error handler
        error: function() {
            signInResultNode.innerHTML = "There was an error with your request.";
        }
    });
}

</script>
</body>
</html>